# 系统设计文档

## 1. 架构设计

### 1.1 整体架构

系统采用前后端分离的微服务架构：

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   Frontend  │  ─────>  │   Backend   │  ─────>  │  Database   │
│   (React)   │          │  (FastAPI)  │          │ (PostgreSQL)│
└─────────────┘         └─────────────┘         └─────────────┘
                              │
                              ▼
                        ┌─────────────┐
                        │ Vector Store│
                        │  (ChromaDB) │
                        └─────────────┘
```

### 1.2 技术栈选择

**后端**：
- **FastAPI**: 现代、高性能的Python Web框架，支持异步、自动生成API文档
- **SQLAlchemy**: 成熟的ORM框架，支持多种数据库
- **Alembic**: 数据库迁移工具，确保数据库版本管理
- **LangChain**: LLM集成框架，支持多种模型提供商

**前端**：
- **React 18**: 成熟的UI框架，组件化开发
- **TypeScript**: 类型安全，提高代码质量
- **Ant Design**: 企业级UI组件库
- **Vite**: 快速的构建工具

**存储**：
- **PostgreSQL**: 主数据库，支持复杂查询和事务
- **ChromaDB**: 向量数据库，用于文档向量存储和检索
- **文件系统**: 文档原始文件存储

### 1.3 分层架构

系统采用经典的分层架构，遵循DDD（领域驱动设计）原则：

```
┌─────────────────────────────────────┐
│         API Layer (FastAPI)          │  ← 接口层
├─────────────────────────────────────┤
│      Service Layer (Business)       │  ← 业务逻辑层
├─────────────────────────────────────┤
│    Repository Layer (Data Access)   │  ← 数据访问层
├─────────────────────────────────────┤
│      Domain Layer (Models)          │  ← 领域模型层
├─────────────────────────────────────┤
│         Database Layer               │  ← 数据库层
└─────────────────────────────────────┘
```

**各层职责**：

1. **API Layer**: 处理HTTP请求、参数验证、响应格式化
2. **Service Layer**: 业务逻辑、事务管理、服务编排
3. **Repository Layer**: 数据持久化、查询封装
4. **Domain Layer**: 领域模型、业务规则、值对象
5. **Database Layer**: 数据存储

## 2. 核心设计模式

### 2.1 领域驱动设计（DDD）

- **实体（Entity）**: 有唯一标识的对象（如User、Document）
- **值对象（Value Object）**: 无标识的不可变对象（如DocumentStatus、DocumentQuery）
- **领域服务（Domain Service）**: 跨实体的业务逻辑（如DocumentDomainService）
- **仓储（Repository）**: 数据访问抽象
- **应用服务（Application Service）**: 用例编排

### 2.2 工厂模式

- **ParserFactory**: 文档解析器工厂，根据文件类型选择解析器
- **StorageFactory**: 存储服务工厂，支持文件系统和对象存储
- **VectorStoreFactory**: 向量库工厂，支持多种向量数据库

### 2.3 策略模式

- **文本切分策略**: 固定长度、段落、关键字三种策略
- **认证策略**: 密码认证、MFA认证（预留）

### 2.4 依赖注入

- 使用FastAPI的依赖注入系统
- Repository和Service通过构造函数注入
- 便于测试和替换实现

## 3. 数据模型设计

### 3.1 多租户设计

系统采用逻辑多租户架构：

- 所有表都包含 `tenant_id` 字段
- 查询时强制过滤 `tenant_id`，确保数据隔离
- 系统管理员 `tenant_id` 为 `NULL`，可访问所有数据

### 3.2 软删除设计

- 所有实体表都包含 `deleted_at` 字段
- 删除操作只设置 `deleted_at`，不物理删除
- 查询时自动过滤已删除记录

### 3.3 版本管理

- 文档支持版本管理（V1、V2...）
- 版本历史独立存储
- 新版本创建后，旧版本向量数据异步清理

## 4. 安全设计

### 4.1 认证与授权

- **JWT Token**: 无状态认证
- **RBAC**: 基于角色的访问控制
- **权限码**: `module:resource:action` 格式
- **多级权限**: 系统级、租户级、用户级

### 4.2 数据安全

- **密码加密**: bcrypt哈希
- **配置加密**: 敏感配置（API Key）Base64加密存储
- **配置脱敏**: 展示时只显示首尾4位

### 4.3 数据隔离

- **租户隔离**: 强制 `tenant_id` 过滤
- **用户隔离**: 用户只能访问自己的数据
- **文件夹隔离**: 文件夹级别的权限控制

## 5. 性能设计

### 5.1 异步处理

- **文档解析**: 异步后台任务
- **向量化**: 异步处理，不阻塞上传
- **文件I/O**: 使用 `asyncio.to_thread` 避免阻塞

### 5.2 缓存策略

- **权限缓存**: 内存缓存，减少数据库查询
- **配置缓存**: 系统启动时加载，运行时查询

### 5.3 数据库优化

- **索引**: 关键字段建立索引（tenant_id、user_id、deleted_at）
- **查询优化**: 避免N+1查询，使用join优化

## 6. 可扩展性设计

### 6.1 模块化设计

- **插件化解析器**: 易于添加新的文档格式支持
- **可插拔存储**: 支持文件系统和对象存储
- **可插拔向量库**: 支持ChromaDB、Milvus等

### 6.2 配置分层

- **三级配置**: 系统级 → 租户级 → 用户级
- **配置继承**: 下级覆盖上级，未配置项继承
- **配置热更新**: 配置修改立即生效

### 6.3 API版本管理

- **URL版本**: `/api/v1/` 前缀
- **向后兼容**: 新版本不破坏旧版本API

## 7. 错误处理

### 7.1 异常层次

```
BaseException
  └── DomainException (领域异常)
       ├── DocumentNotFoundException
       ├── DocumentPermissionDeniedException
       ├── FolderNotFoundException
       └── ...
```

### 7.2 统一错误响应

```json
{
  "detail": "错误描述",
  "error_type": "ExceptionType",
  "status_code": 400
}
```

### 7.3 日志记录

- **结构化日志**: JSON格式，便于分析
- **日志级别**: DEBUG、INFO、WARNING、ERROR
- **审计日志**: 记录所有关键操作

## 8. 测试策略

### 8.1 测试金字塔

```
        /\
       /  \      E2E Tests (少量)
      /____\
     /      \    Integration Tests (中等)
    /________\
   /          \  Unit Tests (大量)
  /____________\
```

### 8.2 测试覆盖

- **单元测试**: 服务层、Repository层
- **集成测试**: API端点、完整工作流
- **前端测试**: 组件、页面、API客户端

## 9. 部署设计

### 9.1 Docker化

- **多阶段构建**: 前端构建和运行分离
- **服务编排**: Docker Compose管理所有服务
- **数据持久化**: Volume挂载，数据不丢失

### 9.2 环境配置

- **环境变量**: 敏感配置通过环境变量注入
- **配置分离**: 开发、测试、生产环境配置分离

## 10. 监控与运维

### 10.1 日志

- **应用日志**: 结构化日志，记录关键操作
- **审计日志**: 记录所有数据变更
- **错误日志**: 记录异常和堆栈信息

### 10.2 健康检查

- **数据库健康**: 连接池状态检查
- **服务健康**: API健康检查端点（预留）

## 11. 未来扩展

### 11.1 微服务化

- 当前为单体应用，未来可拆分为：
  - 用户服务
  - 文档服务
  - 问答服务
  - 配置服务

### 11.2 消息队列

- 文档处理任务可迁移到消息队列（RabbitMQ、Kafka）
- 支持任务重试和优先级

### 11.3 分布式追踪

- 集成OpenTelemetry
- 追踪请求在服务间的流转
