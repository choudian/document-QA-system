# 功能文档

## 系统概述

智能文档问答系统是一个基于多租户架构的个人知识库系统，支持文档管理、智能问答等功能。系统采用 RBAC（基于角色的访问控制）权限模型，支持系统管理员、租户管理员和普通用户三种角色。

## 核心功能模块

### 1. 认证与授权

#### 1.1 用户登录
- **功能描述**：用户通过手机号和密码登录系统
- **特点**：
  - 手机号全局唯一，系统自动识别用户所属租户
  - 支持系统管理员和租户用户统一登录入口
  - 使用 JWT Token 进行身份认证
  - 登录后根据用户权限自动跳转到相应页面

#### 1.2 用户注册（占位）
- **功能描述**：用户注册功能（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 用户自主注册
  - 租户选择
  - 注册验证

#### 1.3 密码重置（占位）
- **功能描述**：用户密码重置功能（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 发送重置验证码（短信/邮件）
  - 验证码验证
  - 新密码设置

#### 1.4 多因素认证（MFA）（占位）
- **功能描述**：多因素认证功能（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - OTP 认证（基于时间的一次性密码）
  - 短信/邮箱 MFA
  - MFA 启用/禁用
  - MFA 验证

#### 1.5 Token 刷新（占位）
- **功能描述**：刷新访问令牌功能（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - Refresh Token 机制
  - Token 自动刷新

#### 1.6 权限管理
- **权限模型**：基于角色的访问控制（RBAC）
- **权限类型**：
  - 菜单权限：控制前端菜单显示
  - 接口权限：控制后端 API 访问
  - 按钮权限：控制前端按钮显示
- **权限命名规范**：`module:resource:action` 格式
  - 例如：`system:user:create`、`system:role:read`

### 2. 租户管理

#### 2.1 租户创建
- **功能描述**：系统管理员可以创建新租户
- **租户信息**：
  - 租户编码（唯一）
  - 租户名称（唯一）
  - 租户描述
  - 租户状态（启用/停用）
- **自动初始化**：
  - 创建租户时自动创建"租户管理员"角色
  - 为租户管理员角色分配默认权限

#### 2.2 租户管理
- **功能列表**：
  - 查看租户列表
  - 查看租户详情
  - 更新租户信息
  - 启用/停用租户
  - 删除租户

### 3. 用户管理

#### 3.1 用户创建
- **功能描述**：系统管理员和租户管理员可以创建用户
- **用户信息**：
  - 用户名（租户内唯一）
  - 手机号（全局唯一，用作登录账号）
  - 密码
  - 所属租户
  - 用户状态（启用/冻结）
- **权限控制**：
  - 系统管理员：可以为任意租户创建用户
  - 租户管理员：只能为本租户创建用户

#### 3.2 用户管理
- **功能列表**：
  - 查看用户列表（按租户筛选）
  - 查看用户详情
  - 更新用户信息
  - 启用/冻结用户
  - 删除用户
  - 为用户分配角色

#### 3.3 用户邀请（占位）
- **功能描述**：邀请用户加入系统（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 生成邀请链接
  - 发送邀请邮件/短信
  - 邀请码管理

#### 3.4 用户批量导入（占位）
- **功能描述**：批量导入用户功能（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - Excel/CSV 文件导入
  - 数据验证
  - 批量创建用户

#### 3.5 用户锁定/解锁（占位）
- **功能描述**：用户账户锁定和解锁功能（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 账户锁定（登录失败次数限制）
  - 手动锁定/解锁
  - 锁定原因记录

### 4. 角色管理

#### 4.1 角色类型
- **系统级角色**：
  - 系统管理员：管理整个系统，可以创建租户、管理所有租户的用户
  - 租户管理员：管理租户内的用户、角色、权限
- **租户级角色**：由租户管理员创建，用于分配给租户内的用户

#### 4.2 角色管理
- **功能列表**：
  - 创建角色
  - 查看角色列表
  - 查看角色详情
  - 更新角色信息
  - 启用/停用角色
  - 删除角色
  - 为角色分配权限
  - 为角色分配用户

### 5. 权限管理

#### 5.1 权限类型
- **系统级权限**：系统管理员使用的权限，如租户管理相关权限
- **租户级权限**：租户管理员和普通用户使用的权限，如用户管理、角色管理、权限管理

#### 5.2 权限管理
- **功能列表**：
  - 查看权限列表
  - 查看权限详情
  - 权限自动初始化：系统启动时自动创建默认权限

### 6. 系统初始化

#### 6.1 系统管理员初始化
- **功能描述**：首次启动系统时，需要初始化系统管理员账号
- **初始化信息**：
  - 用户名
  - 手机号（全局唯一）
  - 密码
- **自动分配**：系统管理员创建后自动分配"系统管理员"角色

#### 6.2 默认数据初始化
- **自动初始化**：
  - 默认权限：系统启动时自动创建所有默认权限
  - 默认角色：自动创建"系统管理员"和"租户管理员"角色
  - 角色权限分配：自动为默认角色分配相应权限

## 用户角色说明

### 系统管理员
- **权限范围**：
  - 管理所有租户（创建、查看、更新、删除、启用/停用）
  - 为任意租户创建用户
  - 创建系统级角色和租户级角色
  - 管理所有权限
- **特点**：
  - 系统只有一个系统管理员账号
  - 不归属于任何租户（tenant_id 为空）
  - 通过"系统管理员"角色判断身份

### 租户管理员
- **权限范围**：
  - 管理本租户内的用户（创建、查看、更新、删除、启用/冻结）
  - 管理本租户内的角色（创建、查看、更新、删除）
  - 查看和管理权限
  - 为用户分配角色
- **特点**：
  - 归属于特定租户
  - 通过"租户管理员"角色判断身份
  - 不能管理其他租户的数据

### 普通用户
- **权限范围**：
  - 根据分配的角色获得相应权限
  - 通常用于文档管理和问答功能
- **特点**：
  - 归属于特定租户
  - 通过角色获得权限

## 数据隔离

### 租户隔离
- **强制隔离**：所有数据查询都强制带上 `tenant_id` 条件
- **隔离范围**：
  - 用户数据：租户管理员只能查看本租户的用户
  - 角色数据：租户管理员只能查看本租户的角色
  - 权限数据：租户管理员可以查看系统级权限和本租户的权限

### 系统级资源
- **系统级角色**：`tenant_id` 为 `None`，所有租户都可以使用
- **系统级权限**：`tenant_id` 为 `None`，所有租户都可以使用

## 技术特性

### 安全性
- **密码加密**：使用 bcrypt 加密存储密码
- **JWT Token**：使用 JWT 进行身份认证
- **权限校验**：所有 API 接口都进行权限校验
- **数据隔离**：严格的租户数据隔离
- **敏感数据保护**：配置中的敏感字段（API Key 等）加密存储并脱敏显示
- **审计日志**：所有 API 请求和响应自动记录，便于审计和分析
- **限流保护**：支持 API 速率限制（占位实现）

### 可扩展性
- **多租户架构**：支持多租户数据隔离
- **RBAC 权限模型**：灵活的权限管理
- **角色继承**：支持通过角色分配权限

### 用户体验
- **统一登录**：手机号登录，自动识别租户
- **权限驱动**：菜单和按钮根据权限动态显示
- **智能跳转**：登录后根据权限自动跳转到相应页面

## 待开发功能

### 文档管理模块
- 文档上传与解析
- 文档版本管理
- 文档标签管理
- 文档搜索

### 问答模块
- 智能问答
- 多轮对话
- 知识库检索
- 对话历史管理

### 7. 配置管理模块

#### 7.1 配置项管理
- **功能描述**：系统级和租户级配置管理
- **配置类型**：
  - LLM 配置（模型、API Key、Base URL 等）
  - Rerank 配置
  - Embedding 配置
  - 向量库配置
  - 文档上传配置（文件类型、大小限制）
  - 文本切分策略配置
  - 检索参数配置
  - Langfuse 配置
- **配置层级**：
  - 系统级配置：系统管理员可配置，作为默认值
  - 租户级配置：租户管理员可配置，覆盖系统级配置
  - 用户级配置：普通用户可配置（在文档/问答模块中）
- **安全特性**：
  - 敏感字段加密存储（API Key 等）
  - 敏感字段脱敏显示（仅显示首尾各 4 位）
  - 配置历史记录

#### 7.2 配置可用性探测（占位）
- **功能描述**：探测配置的可用性（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - LLM API 连接测试
  - 向量库连接测试
  - 密钥有效性验证

#### 7.3 配置分类（占位）
- **功能描述**：配置项分类管理（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 按分类分组展示（模型相关、存储相关、文档相关、问答相关等）
  - 分类管理

### 8. 审计日志

#### 8.1 审计日志记录
- **功能描述**：自动记录所有 API 请求和响应
- **记录内容**：
  - 用户信息（用户ID、租户ID）
  - 请求信息（方法、路径、请求体、查询参数）
  - 响应信息（状态码、响应体）
  - 性能指标（耗时、请求大小、响应大小）
  - 客户端信息（IP 地址、User-Agent）
- **数据脱敏**：自动对敏感字段进行脱敏处理
- **异步记录**：不阻塞请求处理

#### 8.2 审计日志查询
- **功能描述**：查询和查看审计日志
- **查询功能**：
  - 按时间范围查询
  - 按用户查询
  - 按租户查询
  - 按请求方法/路径过滤
  - 查看详细日志信息

#### 8.3 Langfuse 集成
- **功能描述**：集成 Langfuse 进行 LLM 应用观测和评估
- **功能特性**：
  - 自动记录所有 API 请求到 Langfuse（Trace）
  - 支持记录 Generation、Feedback、Score（预留）
  - 配置管理：在配置管理模块中配置 Langfuse
  - 双重记录：同时记录到审计日志表和 Langfuse
- **配置要求**：
  - 需要在配置管理模块中启用 Langfuse
  - 配置 Public Key 和 Secret Key
  - 可配置 Langfuse 服务器地址

### 9. 系统管理（占位）

#### 9.1 额度管理（占位）
- **功能描述**：用户/租户额度管理（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - API 调用额度
  - 存储额度
  - 带宽额度

#### 9.2 速率限制（占位）
- **功能描述**：API 速率限制（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 基于 IP 的限流
  - 基于用户的限流
  - 基于租户的限流

#### 9.3 操作日志（占位）
- **功能描述**：最小操作日志记录（占位实现）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - AOP 切面拦截
  - 操作类型记录
  - 操作详情记录

### 10. 文档管理模块

#### 10.1 文档上传
- **功能描述**：支持上传多种格式的文档文件
- **支持格式**：
  - TXT（.txt）
  - Markdown（.md, .markdown）
  - PDF（.pdf）
  - Word（.doc, .docx）
- **上传特性**：
  - 文件大小限制：默认50MB（可配置：系统/租户/用户三级配置）
  - 文件类型限制：可配置允许上传的文件类型
  - 同名文件检测：上传前检测同名文件，用户可选择覆盖新版本或使用已有文件
  - 自动解析：上传后自动解析为Markdown格式
  - 异步处理：解析和向量化采用异步后台任务处理
- **用户配置**：
  - 上传时可配置文本切分策略（chunk_size、chunk_overlap、split_method、split_keyword）
  - 默认使用用户最近使用的配置
  - 配置继承：系统 -> 租户 -> 用户

#### 10.2 文档解析
- **功能描述**：自动解析上传的文档，统一转换为Markdown格式
- **解析器支持**：
  - 文本解析器：直接读取文本内容
  - Markdown解析器：解析Markdown文件
  - PDF解析器：使用PyPDF2提取PDF文本和元数据
  - Word解析器：使用python-docx提取Word文档内容和元数据
- **解析结果**：
  - 保存原文件和Markdown解析结果
  - 提取文档标题、摘要、页数等元数据
  - 内容清洗（去BOM、统一编码、去危险标签）
- **解析状态**：
  - uploading：上传中
  - uploaded：上传成功
  - parsing：解析中
  - completed：完成（解析和向量化都成功）
  - upload_failed：上传失败
  - parse_failed：解析失败
  - vectorizing：向量化中
  - vectorize_failed：向量化失败

#### 10.3 文档向量化
- **功能描述**：将解析后的文档内容进行向量化，用于智能检索
- **处理流程**：
  1. 文本切分：根据配置将Markdown内容切分为多个chunk
  2. Embedding生成：使用配置的Embedding模型生成向量（支持OpenAI、阿里云等）
  3. 向量存储：存储到向量库（支持ChromaDB本地存储）
  4. Chunk元数据存储：保存chunk的元数据到数据库
- **切分策略**：
  - 固定长度切分（length）：按指定长度和重叠大小切分
  - 段落切分（paragraph）：按段落智能切分
  - 关键字切分（keyword）：按指定关键字切分
- **数据隔离**：三级数据隔离（tenant_id、user_id、folder_id）

#### 10.4 文件夹管理
- **功能描述**：组织和管理文档，支持文件夹层级结构
- **层级限制**：支持根目录+2层子文件夹（共3层）
- **功能特性**：
  - 创建文件夹（指定父文件夹）
  - 查询文件夹列表（支持按父文件夹筛选）
  - 查看文件夹详情
  - 重命名文件夹
  - 删除文件夹（需二次确认，输入确认文字）
  - 文件夹树形结构展示
  - 权限控制：只有拥有者可以看到文件夹

#### 10.5 标签管理
- **功能描述**：为文档添加标签，便于分类和检索
- **标签特性**：
  - 标签属于用户（无全局标签）
  - 标签名称限制：20字以内，无命名规范
  - 自动创建：通过标签名称自动创建标签
  - 自动补全：基于历史标签提供自动补全功能
  - 按标签搜索：支持按标签筛选文档
- **功能操作**：
  - 为文档添加标签（支持通过tag_id或tag_name）
  - 从文档移除标签
  - 查看文档的所有标签
  - 查看用户的所有标签列表（支持搜索）

#### 10.6 版本管理
- **功能描述**：管理文档的版本历史，支持版本覆盖和版本历史查看
- **版本特性**：
  - 版本号规则：V1、V2、V3...自动递增
  - 版本创建：上传同名文件时自动创建新版本，旧版本保存到版本历史
  - 版本覆盖逻辑：新版本解析和向量化成功后，自动删除旧版本的向量数据和chunk数据
  - 版本历史查询：可以查看文档的所有版本历史
  - 版本删除：可以手动删除指定版本（仅所有者，不能删除当前版本）
  - 版本限制：版本历史不限制数量
- **版本记录信息**：
  - 版本号
  - 文件哈希值
  - 存储路径
  - Markdown路径
  - 操作者ID
  - 创建时间
  - 是否当前版本

#### 10.7 文档列表和查询
- **功能描述**：查看和管理文档列表
- **查询功能**：
  - 按文件夹筛选文档
  - 按状态筛选文档（uploading、parsing、completed等）
  - 按标签筛选文档
  - 分页查询（skip、limit）
- **文档信息**：
  - 基本信息：文件名、文件类型、文件大小、版本号
  - 状态信息：文档状态、创建时间、更新时间
  - 元数据：标题、摘要、页数
  - 配置信息：文本切分策略配置

#### 10.8 文档详情
- **功能描述**：查看文档的详细信息
- **详情信息**：
  - 文档基本信息
  - 文档配置（文本切分策略）
  - 文档状态
  - 元数据（标题、摘要、页数等）
  - 版本信息

#### 10.9 文档删除和恢复
- **功能描述**：软删除文档，支持恢复
- **删除特性**：
  - 软删除：逻辑删除，不删除物理文件
  - 同步删除：删除向量库索引和chunk数据
  - 等待处理完成：删除前检查文档是否正在处理中
  - 回收站：删除的文档进入回收站
- **恢复特性**：
  - 从回收站恢复文档
  - 恢复后需要重新向量化（向量数据已删除）

#### 10.10 文档下载
- **功能描述**：下载文档的原文件
- **下载特性**：
  - 下载原文件（非Markdown版本）
  - 保留原始文件名和MIME类型
  - 权限控制：只有有权限的用户可以下载

#### 10.11 文档预览（预留）
- **功能描述**：预览文档的Markdown内容（预留接口）
- **状态**：占位实现，实际功能待完善

#### 10.12 文档配置管理
- **功能描述**：管理文档的文本切分配置
- **配置项**：
  - chunk_size：文本切分块大小（默认400）
  - chunk_overlap：文本切分重叠大小（默认100）
  - split_method：切分方法（length/paragraph/keyword）
  - split_keyword：切分关键字（当split_method=keyword时使用）
- **配置特性**：
  - 每个文档独立配置（文档-配置一对一）
  - 用户最近使用的配置：自动保存用户最近使用的配置作为默认值
  - 配置继承：系统 -> 租户 -> 用户
  - 配置查看：可以查看用户最近使用的配置

#### 10.13 待办表功能（预留接口）
- **功能描述**：管理解析/向量化失败的任务（预留接口）
- **状态**：占位实现，实际功能待完善
- **预留功能**：
  - 失败任务自动加入待办表
  - 查看待办任务列表
  - 查看待办任务详情
  - 删除待办任务
  - 定时扫描和清理机制

## 待开发功能

### 问答模块
- 智能问答
- 多轮对话
- 知识库检索
- 对话历史管理
- 引用片段展示
