# 接口文档

## 基础信息

- **Base URL**: `http://localhost:8000/api/v1`
- **认证方式**: JWT Bearer Token
- **Content-Type**: `application/json`

## 认证说明

### 获取 Token

所有需要认证的接口都需要在请求头中携带 Token：

```
Authorization: Bearer <token>
```

### Token 获取方式

通过登录接口获取 Token，Token 包含以下信息：
- `sub`: 用户ID
- `tenant_id`: 租户ID（系统管理员为 null）
- `is_system_admin`: 是否是系统管理员
- `is_tenant_admin`: 是否是租户管理员

### Token 刷新（占位）

系统支持 Token 刷新机制（占位实现），可以通过刷新接口获取新的访问令牌。实际实现时，Token 有效期和刷新机制可能会有所不同。

## 接口列表

### 1. 认证接口

#### 1.1 用户登录

**接口地址**: `POST /auth/login`

**接口描述**: 用户通过手机号和密码登录系统

**请求参数**:

```json
{
  "phone": "13800138000",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**说明**:
- 系统会根据手机号自动识别用户所属租户
- 系统管理员和租户用户使用统一登录接口

#### 1.2 用户注册（占位）

**接口地址**: `POST /auth/register`

**接口描述**: 用户注册功能（占位实现）

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "username": "user001",
  "phone": "13800138001",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 是 | 租户ID |
| username | string | 是 | 用户名（租户内唯一） |
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "message": "注册成功",
  "user_id": "user-id"
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 1.3 请求重置密码（占位）

**接口地址**: `POST /auth/reset-password`

**接口描述**: 请求重置密码，发送验证码（占位实现）

**请求参数**:

```json
{
  "phone": "13800138000",
  "tenant_id": "tenant-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| phone | string | 是 | 手机号 |
| tenant_id | string | 否 | 租户ID（可选） |

**响应示例**:

```json
{
  "message": "验证码已发送（占位实现）",
  "verification_code": "123456"
}
```

**说明**: 此功能为占位实现，实际功能待完善。实际实现时不应返回验证码。

#### 1.4 确认重置密码（占位）

**接口地址**: `POST /auth/reset-password/confirm`

**接口描述**: 确认重置密码（占位实现）

**请求参数**:

```json
{
  "phone": "13800138000",
  "verification_code": "123456",
  "new_password": "newpassword123",
  "tenant_id": "tenant-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| phone | string | 是 | 手机号 |
| verification_code | string | 是 | 验证码 |
| new_password | string | 是 | 新密码（至少6个字符） |
| tenant_id | string | 否 | 租户ID（可选） |

**响应示例**:

```json
{
  "message": "密码重置成功"
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 1.5 启用 MFA（占位）

**接口地址**: `POST /auth/mfa/enable`

**接口描述**: 启用多因素认证（占位实现）

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "mfa_type": "otp"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| mfa_type | string | 否 | MFA 类型（otp/sms/email，默认 otp） |

**响应示例**:

```json
{
  "enabled": true,
  "secret": "JBSWY3DPEHPK3PXP",
  "qr_code_url": "data:image/png;base64,占位二维码",
  "totp_uri": "otpauth://totp/..."
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 1.6 禁用 MFA（占位）

**接口地址**: `POST /auth/mfa/disable`

**接口描述**: 禁用多因素认证（占位实现）

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "message": "MFA 已禁用"
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 1.7 验证 MFA（占位）

**接口地址**: `POST /auth/mfa/verify`

**接口描述**: 验证 MFA 代码（占位实现）

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "code": "123456"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | MFA 验证码 |

**响应示例**:

```json
{
  "message": "MFA 验证成功"
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 1.8 刷新 Token（占位）

**接口地址**: `POST /auth/refresh`

**接口描述**: 刷新访问令牌（占位实现）

**请求参数**:

```json
{
  "refresh_token": "refresh-token-string"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| refresh_token | string | 是 | 刷新 Token |

**响应示例**:

```json
{
  "access_token": "new-access-token",
  "token_type": "bearer",
  "refresh_token": null
}
```

**说明**: 此功能为占位实现，实际功能待完善

---

### 2. 当前用户接口

#### 2.1 获取当前用户信息

**接口地址**: `GET /me`

**接口描述**: 获取当前登录用户的信息

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "id": "user-id",
  "tenant_id": "tenant-id",
  "username": "admin",
  "phone": "13800138000",
  "status": "active",
  "is_tenant_admin": false,
  "is_system_admin": true,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

#### 2.2 获取当前用户权限

**接口地址**: `GET /me/permissions`

**接口描述**: 获取当前用户的所有权限列表

**请求头**: 需要携带 Token

**响应示例**:

```json
[
  {
    "code": "system:user:create",
    "name": "创建用户",
    "type": "button"
  },
  {
    "code": "system:user:read",
    "name": "查看用户",
    "type": "menu"
  }
]
```

---

### 3. 系统管理员接口

#### 3.1 检查系统管理员是否存在

**接口地址**: `GET /system-admin/exists`

**接口描述**: 检查系统中是否已存在系统管理员

**响应示例**:

```json
{
  "exists": true
}
```

#### 3.2 初始化系统管理员

**接口地址**: `POST /system-admin/init`

**接口描述**: 初始化系统管理员账号（仅首次使用）

**请求参数**:

```json
{
  "username": "admin",
  "phone": "13800138000",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名 |
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "message": "系统管理员创建成功"
}
```

**说明**:
- 系统管理员只能创建一次
- 创建后会自动分配"系统管理员"角色

---

### 4. 租户管理接口

#### 4.1 创建租户

**接口地址**: `POST /tenants`

**接口描述**: 创建新租户（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "code": "TENANT001",
  "name": "示例租户",
  "description": "租户描述"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 租户编码（全局唯一） |
| name | string | 是 | 租户名称（全局唯一） |
| description | string | 否 | 租户描述 |

**响应示例**:

```json
{
  "id": "tenant-id",
  "code": "TENANT001",
  "name": "示例租户",
  "description": "租户描述",
  "status": true,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

#### 4.2 查询租户列表

**接口地址**: `GET /tenants`

**接口描述**: 查询租户列表（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| status | bool | 否 | 状态过滤（true-启用，false-停用） |

**响应示例**:

```json
[
  {
    "id": "tenant-id",
    "code": "TENANT001",
    "name": "示例租户",
    "status": true
  }
]
```

#### 4.3 查询单个租户

**接口地址**: `GET /tenants/{tenant_id}`

**接口描述**: 查询单个租户详情（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| tenant_id | string | 租户ID |

#### 4.4 更新租户

**接口地址**: `PUT /tenants/{tenant_id}`

**接口描述**: 更新租户信息（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "name": "新租户名称",
  "description": "新描述"
}
```

#### 4.5 删除租户

**接口地址**: `DELETE /tenants/{tenant_id}`

**接口描述**: 删除租户（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

#### 4.6 启用/停用租户

**接口地址**: `PATCH /tenants/{tenant_id}/status`

**接口描述**: 启用或停用租户（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "status": true
}
```

---

### 5. 用户管理接口

#### 5.1 创建用户

**接口地址**: `POST /users`

**接口描述**: 创建新用户

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "username": "user001",
  "phone": "13800138001",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 是* | 租户ID（系统管理员必填，租户管理员自动使用其tenant_id） |
| username | string | 是 | 用户名（租户内唯一） |
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "id": "user-id",
  "tenant_id": "tenant-id",
  "username": "user001",
  "phone": "13800138001",
  "status": "active",
  "is_tenant_admin": false,
  "is_system_admin": false,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

**权限说明**:
- 系统管理员：可以为任意租户创建用户
- 租户管理员：只能为本租户创建用户（tenant_id 自动填充）

#### 5.2 查询用户列表

**接口地址**: `GET /users`

**接口描述**: 查询用户列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 是 | 租户ID（系统管理员必填，租户管理员自动使用其tenant_id） |
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| status | string | 否 | 状态过滤（active-启用，frozen-冻结） |

**权限说明**:
- 系统管理员：必须指定 tenant_id，可以查看任意租户的用户
- 租户管理员：自动使用其 tenant_id，只能查看本租户的用户

#### 5.3 查询单个用户

**接口地址**: `GET /users/{user_id}`

**接口描述**: 查询单个用户详情

**请求头**: 需要携带 Token

**权限说明**:
- 系统管理员：可以查看任意用户
- 租户管理员：只能查看本租户的用户

#### 5.4 更新用户

**接口地址**: `PUT /users/{user_id}`

**接口描述**: 更新用户信息

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "username": "new-username",
  "phone": "13800138002",
  "password": "new-password",
  "status": "active",
  "tenant_id": "tenant-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 否 | 用户名 |
| phone | string | 否 | 手机号 |
| password | string | 否 | 密码（留空则不修改） |
| status | string | 否 | 状态（active/frozen） |
| tenant_id | string | 否 | 租户ID（仅系统管理员可修改） |

**权限说明**:
- 系统管理员：可以修改任意用户信息，包括 tenant_id
- 租户管理员：只能修改本租户的用户信息，不能修改 tenant_id

#### 5.5 删除用户

**接口地址**: `DELETE /users/{user_id}`

**接口描述**: 删除用户

**请求头**: 需要携带 Token

**权限说明**:
- 系统管理员：可以删除任意用户
- 租户管理员：只能删除本租户的用户

#### 5.6 启用/冻结用户

**接口地址**: `PATCH /users/{user_id}/status`

**接口描述**: 启用或冻结用户

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "status": "active"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | string | 是 | 状态（active-启用，frozen-冻结） |

#### 5.7 邀请用户（占位）

**接口地址**: `POST /users/invite`

**接口描述**: 邀请用户加入系统（占位实现）

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "email": "user@example.com",
  "phone": "13800138001",
  "username": "user001",
  "role_ids": ["role-id-1"]
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| email | string | 否 | 邮箱地址（可选） |
| phone | string | 是 | 手机号 |
| username | string | 否 | 用户名（可选，默认使用手机号） |
| role_ids | array | 否 | 角色ID列表（可选） |

**响应示例**:

```json
{
  "invite_code": "invite-code-string",
  "invite_url": "https://example.com/invite/invite-code-string",
  "expires_at": "2025-01-08T00:00:00"
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 5.8 批量导入用户（占位）

**接口地址**: `POST /users/import`

**接口描述**: 批量导入用户（占位实现）

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "file_url": "https://example.com/users.xlsx",
  "file_content": "base64-encoded-content",
  "file_type": "excel"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file_url | string | 否 | 文件URL（可选） |
| file_content | string | 否 | 文件内容（Base64编码，可选） |
| file_type | string | 是 | 文件类型（excel/csv） |

**响应示例**:

```json
{
  "total": 0,
  "success": 0,
  "failed": 0,
  "errors": []
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 5.9 锁定用户（占位）

**接口地址**: `POST /users/{user_id}/lock`

**接口描述**: 锁定用户账户（占位实现）

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "message": "用户已锁定（占位实现）"
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 5.10 解锁用户（占位）

**接口地址**: `POST /users/{user_id}/unlock`

**接口描述**: 解锁用户账户（占位实现）

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "message": "用户已解锁（占位实现）"
}
```

**说明**: 此功能为占位实现，实际功能待完善

---

### 6. 角色管理接口

#### 6.1 创建角色

**接口地址**: `POST /roles`

**接口描述**: 创建新角色

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "name": "角色名称",
  "description": "角色描述",
  "status": true
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 否 | 租户ID（None表示系统级角色，仅系统管理员可创建） |
| name | string | 是 | 角色名称（租户内唯一） |
| description | string | 否 | 角色描述 |
| status | bool | 否 | 状态（默认true） |

**权限说明**:
- 系统管理员：可以创建系统级角色（tenant_id为None）或租户级角色
- 租户管理员：只能创建租户级角色（tenant_id自动填充）

#### 6.2 查询角色列表

**接口地址**: `GET /roles`

**接口描述**: 查询角色列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| status | bool | 否 | 状态过滤 |

**权限说明**:
- 系统管理员：可以查看所有角色（系统级和租户级）
- 租户管理员：只能查看本租户的角色和系统级角色

#### 6.3 查询单个角色

**接口地址**: `GET /roles/{role_id}`

**接口描述**: 查询单个角色详情

**请求头**: 需要携带 Token

#### 6.4 更新角色

**接口地址**: `PUT /roles/{role_id}`

**接口描述**: 更新角色信息

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "name": "新角色名称",
  "description": "新描述",
  "status": true
}
```

#### 6.5 删除角色

**接口地址**: `DELETE /roles/{role_id}`

**接口描述**: 删除角色

**请求头**: 需要携带 Token

#### 6.6 为角色分配权限

**接口地址**: `POST /roles/{role_id}/permissions`

**接口描述**: 为角色分配权限

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "permission_ids": ["permission-id-1", "permission-id-2"]
}
```

**权限说明**:
- 系统级角色：可以分配任意权限
- 租户级角色：只能分配系统级权限或本租户的权限

#### 6.7 为角色分配用户

**接口地址**: `POST /roles/{role_id}/users`

**接口描述**: 为角色分配用户

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "user_ids": ["user-id-1", "user-id-2"]
}
```

**权限说明**:
- 系统级角色：可以分配给任意租户的用户
- 租户级角色：只能分配给本租户的用户

#### 6.8 获取角色的权限列表

**接口地址**: `GET /roles/{role_id}/permissions`

**接口描述**: 获取角色已分配的权限列表

**请求头**: 需要携带 Token

#### 6.9 获取角色的用户列表

**接口地址**: `GET /roles/{role_id}/users`

**接口描述**: 获取角色已分配的用户列表

**请求头**: 需要携带 Token

#### 6.10 为用户分配角色

**接口地址**: `POST /users/{user_id}/roles`

**接口描述**: 为用户分配角色

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "role_ids": ["role-id-1", "role-id-2"]
}
```

**权限说明**:
- 系统级角色：可以分配给任意租户的用户
- 租户级角色：只能分配给本租户的用户

---

### 7. 权限管理接口

#### 7.1 创建权限

**接口地址**: `POST /permissions`

**接口描述**: 创建新权限

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "code": "system:resource:action",
  "name": "权限名称",
  "description": "权限描述",
  "type": "menu",
  "module": "system",
  "tenant_id": "tenant-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 权限编码（全局唯一，格式：module:resource:action） |
| name | string | 是 | 权限名称 |
| description | string | 否 | 权限描述 |
| type | string | 是 | 权限类型（menu/api/button） |
| module | string | 是 | 所属模块 |
| tenant_id | string | 否 | 租户ID（None表示系统级权限） |

#### 7.2 查询权限列表

**接口地址**: `GET /permissions`

**接口描述**: 查询权限列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| module | string | 否 | 模块过滤 |
| type | string | 否 | 类型过滤（menu/api/button） |
| status | bool | 否 | 状态过滤 |

**权限说明**:
- 系统管理员：可以查看所有权限
- 租户管理员：可以查看系统级权限和本租户的权限，但会过滤掉租户管理相关权限（system:tenant:*）

#### 7.3 查询单个权限

**接口地址**: `GET /permissions/{permission_id}`

**接口描述**: 查询单个权限详情

**请求头**: 需要携带 Token

#### 7.4 更新权限

**接口地址**: `PUT /permissions/{permission_id}`

**接口描述**: 更新权限信息

**请求头**: 需要携带 Token

#### 7.5 删除权限

**接口地址**: `DELETE /permissions/{permission_id}`

**接口描述**: 删除权限

**请求头**: 需要携带 Token

#### 7.6 启用/停用权限

**接口地址**: `PATCH /permissions/{permission_id}/status`

**接口描述**: 启用或停用权限

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "status": true
}
```

---

### 8. 配置管理接口

#### 8.1 查询配置列表

**接口地址**: `GET /configs`

**接口描述**: 按作用域查询配置列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| scope | string | 否 | 作用域（system/tenant/user，默认 system） |
| scope_id | string | 否 | 作用域ID（租户ID或用户ID） |

**权限说明**:
- 系统管理员：可以查看系统级配置
- 租户管理员：可以查看租户级配置

#### 8.2 获取有效配置

**接口地址**: `GET /configs/effective`

**接口描述**: 获取有效配置（系统 -> 租户 -> 用户 逐层覆盖）

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 否 | 租户ID |
| user_id | string | 否 | 用户ID |

#### 8.3 更新配置

**接口地址**: `PUT /configs`

**接口描述**: 统一更新配置接口，根据用户角色自动判断配置层级

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "items": [
    {
      "category": "llm",
      "key": "default",
      "value": {
        "provider": "openai",
        "base_url": "https://api.openai.com/v1",
        "api_key": "sk-...",
        "model": "gpt-4o-mini"
      },
      "status": true
    }
  ]
}
```

**权限说明**:
- 系统管理员：更新系统级配置
- 租户管理员：更新租户级配置（如果配置项为空，则删除租户级配置，回退到系统级默认值）

#### 8.4 获取配置定义

**接口地址**: `GET /configs/definitions`

**接口描述**: 获取配置项定义（用于前端动态渲染表单）

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "definitions": [
    {
      "category": "llm",
      "key": "default",
      "label": "LLM（默认）",
      "fields": [
        {
          "name": "provider",
          "type": "string",
          "required": true,
          "sensitive": false,
          "label": "Provider",
          "placeholder": "openai / azure / aliyun ..."
        }
      ]
    }
  ]
}
```

#### 8.5 探测配置可用性（占位）

**接口地址**: `POST /configs/probe`

**接口描述**: 探测配置的可用性（占位实现）

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "category": "llm",
  "key": "default",
  "scope": "system",
  "scope_id": null
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| category | string | 是 | 配置类别（llm/embedding/rerank/vector_store） |
| key | string | 否 | 配置键（默认 default） |
| scope | string | 否 | 配置作用域（system/tenant/user，默认 system） |
| scope_id | string | 否 | 作用域ID（租户ID或用户ID） |

**响应示例**:

```json
{
  "available": true,
  "message": "配置可用性检测成功（占位实现）",
  "latency_ms": 100
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 8.6 获取配置分类（占位）

**接口地址**: `GET /configs/categories`

**接口描述**: 获取配置项分类（占位实现）

**请求头**: 需要携带 Token

**响应示例**:

```json
[
  {
    "category": "model",
    "label": "模型相关",
    "configs": ["llm.default", "rerank.default", "embedding.default"]
  },
  {
    "category": "storage",
    "label": "存储相关",
    "configs": ["vector_store.default"]
  }
]
```

**说明**: 此功能为占位实现，实际功能待完善

---

### 9. 审计日志接口

#### 9.1 查询审计日志列表

**接口地址**: `GET /audit-logs`

**接口描述**: 查询审计日志列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| method | string | 否 | HTTP 方法过滤 |
| path | string | 否 | 请求路径过滤（支持模糊匹配） |
| user_id | string | 否 | 用户ID过滤 |
| tenant_id | string | 否 | 租户ID过滤（仅系统管理员可见） |
| start_time | string | 否 | 开始时间（ISO 格式） |
| end_time | string | 否 | 结束时间（ISO 格式） |

**权限说明**:
- 系统管理员：可以查看所有审计日志
- 租户管理员：只能查看本租户的审计日志

#### 9.2 查询审计日志详情

**接口地址**: `GET /audit-logs/{log_id}`

**接口描述**: 查询单个审计日志详情

**请求头**: 需要携带 Token

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| log_id | string | 日志ID |

---

### 10. 系统管理接口（占位）

#### 10.1 获取额度信息（占位）

**接口地址**: `GET /system-admin/quota`

**接口描述**: 获取额度信息（占位实现）

**请求头**: 需要携带 Token（系统管理员）

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 否 | 租户ID |
| user_id | string | 否 | 用户ID |
| quota_type | string | 否 | 额度类型（api_calls/storage/bandwidth） |

**响应示例**:

```json
[]
```

**说明**: 此功能为占位实现，实际功能待完善

#### 10.2 设置额度（占位）

**接口地址**: `POST /system-admin/quota`

**接口描述**: 设置额度（占位实现）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "user_id": "user-id",
  "quota_type": "api_calls",
  "limit": 10000
}
```

**响应示例**:

```json
{
  "message": "额度设置功能尚未实现（占位）",
  "quota_type": "api_calls",
  "limit": 10000
}
```

**说明**: 此功能为占位实现，实际功能待完善

#### 10.3 获取速率限制（占位）

**接口地址**: `GET /system-admin/rate-limit`

**接口描述**: 获取速率限制信息（占位实现）

**请求头**: 需要携带 Token（系统管理员）

**响应示例**:

```json
[]
```

**说明**: 此功能为占位实现，实际功能待完善

#### 10.4 设置速率限制（占位）

**接口地址**: `POST /system-admin/rate-limit`

**接口描述**: 设置速率限制（占位实现）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "user_id": "user-id",
  "limit_type": "requests_per_second",
  "limit_value": 100
}
```

**响应示例**:

```json
{
  "message": "速率限制设置功能尚未实现（占位）",
  "limit_type": "requests_per_second",
  "limit_value": 100
}
```

**说明**: 此功能为占位实现，实际功能待完善

---

### 11. 文档管理接口

#### 11.1 文件夹管理

##### 11.1.1 创建文件夹

**接口地址**: `POST /documents/folders`

**接口描述**: 创建文件夹

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "name": "文件夹名称",
  "parent_id": "parent-folder-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | string | 是 | 文件夹名称 |
| parent_id | string | 否 | 父文件夹ID（为空表示根目录） |

**响应示例**:

```json
{
  "id": "folder-id",
  "tenant_id": "tenant-id",
  "user_id": "user-id",
  "parent_id": null,
  "name": "文件夹名称",
  "path": "tenant-id/user-id/folder-id",
  "level": 0,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

**权限**: `doc:folder:create`

##### 11.1.2 查询文件夹列表

**接口地址**: `GET /documents/folders`

**接口描述**: 查询文件夹列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| parent_id | string | 否 | 父文件夹ID（为空表示根目录） |

**权限**: `doc:folder:read`

##### 11.1.3 查询文件夹详情

**接口地址**: `GET /documents/folders/{folder_id}`

**接口描述**: 查询文件夹详情

**请求头**: 需要携带 Token

**权限**: `doc:folder:read`

##### 11.1.4 更新文件夹

**接口地址**: `PUT /documents/folders/{folder_id}`

**接口描述**: 重命名文件夹

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "name": "新文件夹名称"
}
```

**权限**: `doc:folder:update`

##### 11.1.5 删除文件夹

**接口地址**: `DELETE /documents/folders/{folder_id}`

**接口描述**: 删除文件夹（需二次确认）

**请求头**: 需要携带 Token

**请求参数**（Form Data）:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| confirm_text | string | 是 | 确认文字（需输入"我确认删除某某文件夹"） |

**权限**: `doc:folder:delete`

#### 11.2 文档上传

##### 11.2.1 检查同名文件

**接口地址**: `POST /documents/check-duplicate`

**接口描述**: 检查同名文件是否存在

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "filename": "文档名称.pdf",
  "folder_id": "folder-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| filename | string | 是 | 文件名 |
| folder_id | string | 否 | 文件夹ID（为空表示根目录） |

**响应示例**:

```json
{
  "exists": true,
  "document_id": "document-id",
  "version": "V1"
}
```

**权限**: `doc:file:read`

##### 11.2.2 上传文档

**接口地址**: `POST /documents/upload`

**接口描述**: 上传文档

**请求头**: 需要携带 Token

**请求参数**（Form Data）:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | file | 是 | 文件 |
| folder_id | string | 否 | 文件夹ID（为空表示根目录） |
| chunk_size | int | 否 | 文本切分块大小 |
| chunk_overlap | int | 否 | 文本切分重叠大小 |
| split_method | string | 否 | 切分方法（length/paragraph/keyword） |
| split_keyword | string | 否 | 切分关键字（当split_method=keyword时使用） |

**响应示例**:

```json
{
  "id": "document-id",
  "name": "文档名称.pdf",
  "status": "uploaded",
  "created_at": "2025-01-01T00:00:00"
}
```

**权限**: `doc:file:upload`

**说明**:
- 支持的文件类型：txt、md、pdf、doc、docx
- 文件大小限制由配置决定（默认50MB）
- 上传后自动解析和向量化（异步处理）

#### 11.3 文档列表和查询

##### 11.3.1 查询文档列表

**接口地址**: `GET /documents`

**接口描述**: 查询文档列表（支持按标签筛选）

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| folder_id | string | 否 | 文件夹ID（为空表示根目录） |
| status | string | 否 | 状态过滤（uploading/uploaded/parsing/completed等） |
| tag | string | 否 | 标签名称（按标签筛选） |
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |

**权限**: `doc:file:read`

#### 11.4 文档详情

##### 11.4.1 查询文档详情

**接口地址**: `GET /documents/{document_id}`

**接口描述**: 查询文档详情

**请求头**: 需要携带 Token

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| document_id | string | 文档ID |

**响应示例**:

```json
{
  "id": "document-id",
  "tenant_id": "tenant-id",
  "user_id": "user-id",
  "folder_id": "folder-id",
  "name": "文档名称.pdf",
  "original_name": "文档名称.pdf",
  "file_type": "pdf",
  "mime_type": "application/pdf",
  "file_size": 1024000,
  "file_hash": "sha256-hash",
  "version": "V1",
  "status": "completed",
  "page_count": 10,
  "title": "文档标题",
  "summary": "文档摘要",
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00",
  "config": {
    "chunk_size": 400,
    "chunk_overlap": 100,
    "split_method": "length",
    "split_keyword": null
  }
}
```

**权限**: `doc:file:read`

##### 11.4.2 下载文档

**接口地址**: `GET /documents/{document_id}/download`

**接口描述**: 下载文档原文件

**请求头**: 需要携带 Token

**响应**: 文件流

**权限**: `doc:file:read`

##### 11.4.3 预览文档（预留）

**接口地址**: `GET /documents/{document_id}/preview`

**接口描述**: 预览文档Markdown（预留接口）

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "message": "预览功能待实现"
}
```

**说明**: 此功能为占位实现，实际功能待完善

**权限**: `doc:file:read`

#### 11.5 文档删除和恢复

##### 11.5.1 删除文档

**接口地址**: `DELETE /documents/{document_id}`

**接口描述**: 删除文档（软删除）

**请求头**: 需要携带 Token

**权限**: `doc:file:delete`

**说明**:
- 软删除，不删除物理文件
- 同步删除向量库索引和chunk数据
- 删除前检查文档是否正在处理中

##### 11.5.2 恢复文档

**接口地址**: `POST /documents/{document_id}/restore`

**接口描述**: 恢复软删除的文档

**请求头**: 需要携带 Token

**响应**: 返回文档详情

**权限**: `doc:file:update`

**说明**: 恢复后需要重新向量化（向量数据已删除）

##### 11.5.3 查询回收站文档列表

**接口地址**: `GET /documents/trash`

**接口描述**: 查询回收站文档列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |

**权限**: `doc:file:read`

#### 11.6 标签管理

##### 11.6.1 查询标签列表

**接口地址**: `GET /documents/tags`

**接口描述**: 获取用户标签列表（用于自动补全）

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| search | string | 否 | 搜索关键词 |

**权限**: `doc:file:read`

##### 11.6.2 为文档添加标签

**接口地址**: `POST /documents/{document_id}/tags`

**接口描述**: 为文档添加标签（支持通过tag_id或tag_name）

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "tag_id": "tag-id"
}
```

或者

```json
{
  "tag_name": "标签名称"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tag_id | string | 否* | 标签ID（与tag_name二选一） |
| tag_name | string | 否* | 标签名称（与tag_id二选一，会自动创建） |

**权限**: `doc:file:update`

##### 11.6.3 从文档移除标签

**接口地址**: `DELETE /documents/{document_id}/tags/{tag_id}`

**接口描述**: 从文档移除标签

**请求头**: 需要携带 Token

**权限**: `doc:file:update`

##### 11.6.4 获取文档的所有标签

**接口地址**: `GET /documents/{document_id}/tags`

**接口描述**: 获取文档的所有标签

**请求头**: 需要携带 Token

**权限**: `doc:file:read`

#### 11.7 版本管理

##### 11.7.1 获取文档版本历史

**接口地址**: `GET /documents/{document_id}/versions`

**接口描述**: 获取文档版本历史

**请求头**: 需要携带 Token

**响应示例**:

```json
[
  {
    "id": "version-id",
    "document_id": "document-id",
    "version": "V1",
    "file_hash": "sha256-hash",
    "storage_path": "storage/path",
    "markdown_path": "storage/path.md",
    "operator_id": "user-id",
    "remark": null,
    "created_at": "2025-01-01T00:00:00",
    "is_current": false
  }
]
```

**权限**: `doc:file:read`

##### 11.7.2 删除指定版本

**接口地址**: `DELETE /documents/{document_id}/versions/{version_id}`

**接口描述**: 删除指定版本（仅所有者，不能删除当前版本）

**请求头**: 需要携带 Token

**权限**: `doc:file:delete`

#### 11.8 文档配置

##### 11.8.1 获取用户最近使用的配置

**接口地址**: `GET /documents/config/recent`

**接口描述**: 获取用户最近使用的配置

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "chunk_size": 400,
  "chunk_overlap": 100,
  "split_method": "length",
  "split_keyword": null
}
```

**权限**: `doc:file:read`

#### 11.9 待办表（预留接口）

##### 11.9.1 查询文档任务列表

**接口地址**: `GET /documents/tasks`

**接口描述**: 查询文档任务列表（待办表）（占位实现）

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| task_type | string | 否 | 任务类型（parse_failed/vectorize_failed） |
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |

**说明**: 此功能为占位实现，实际功能待完善

**权限**: `doc:file:read`

##### 11.9.2 获取文档任务详情

**接口地址**: `GET /documents/tasks/{task_id}`

**接口描述**: 获取文档任务详情（占位实现）

**请求头**: 需要携带 Token

**说明**: 此功能为占位实现，实际功能待完善

**权限**: `doc:file:read`

##### 11.9.3 删除文档任务

**接口地址**: `DELETE /documents/tasks/{task_id}`

**接口描述**: 删除文档任务（占位实现）

**请求头**: 需要携带 Token

**说明**: 此功能为占位实现，实际功能待完善

**权限**: `doc:file:delete`

---

## 错误码说明

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（Token无效或过期） |
| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 错误响应格式

```json
{
  "detail": "错误描述信息"
}
```

### 常见错误

1. **401 Unauthorized**: Token 无效或过期，需要重新登录
2. **403 Forbidden**: 无权限访问该资源
3. **400 Bad Request**: 请求参数错误，如：
   - 手机号已被占用
   - 用户名在租户内已存在
   - 租户编码已存在
   - 密码格式不正确

---

## 数据模型

### 用户（User）

```json
{
  "id": "string",
  "tenant_id": "string | null",
  "username": "string",
  "phone": "string",
  "status": "active | frozen",
  "is_tenant_admin": false,
  "is_system_admin": false,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 租户（Tenant）

```json
{
  "id": "string",
  "code": "string",
  "name": "string",
  "description": "string | null",
  "status": true,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 角色（Role）

```json
{
  "id": "string",
  "tenant_id": "string | null",
  "name": "string",
  "description": "string | null",
  "status": true,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 权限（Permission）

```json
{
  "id": "string",
  "code": "string",
  "name": "string",
  "description": "string | null",
  "type": "menu | api | button",
  "module": "string",
  "tenant_id": "string | null",
  "status": true,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

---

## 注意事项

1. **Token 有效期**: Token 默认有效期为 24 小时，过期后需要重新登录
2. **租户隔离**: 所有数据查询都强制进行租户隔离，租户管理员只能访问本租户的数据
3. **手机号唯一性**: 手机号在整个系统中必须唯一
4. **用户名唯一性**: 用户名在同一租户内必须唯一
5. **角色分配**: 为用户分配角色后，系统会自动更新用户的 `is_tenant_admin` 状态
6. **系统管理员判断**: 系统通过检查用户是否有"系统管理员"角色来判断是否是系统管理员
7. **占位接口**: 部分接口标记为"占位实现"，这些接口提供了基本框架，但实际功能待完善
8. **敏感数据**: 配置中的敏感字段（如 API Key）会自动加密存储并脱敏显示
9. **审计日志**: 所有 API 请求和响应都会自动记录到审计日志，包括敏感数据的脱敏版本
10. **Langfuse 集成**: 如果启用了 Langfuse，所有 API 请求也会同步记录到 Langfuse（Trace）

---

## 接口测试

可以使用以下工具测试接口：

1. **Swagger UI**: 访问 `http://localhost:8000/docs` 查看交互式 API 文档
2. **Postman**: 导入接口文档进行测试
3. **curl**: 使用命令行工具测试

### 示例：使用 curl 登录

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "password123"
  }'
```

### 示例：使用 curl 获取用户列表

```bash
curl -X GET "http://localhost:8000/api/v1/users?tenant_id=tenant-id" \
  -H "Authorization: Bearer <token>"
```
