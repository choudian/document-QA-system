# 接口文档

## 基础信息

- **Base URL**: `http://localhost:8000/api/v1`
- **认证方式**: JWT Bearer Token
- **Content-Type**: `application/json`

## 认证说明

### 获取 Token

所有需要认证的接口都需要在请求头中携带 Token：

```
Authorization: Bearer <token>
```

### Token 获取方式

通过登录接口获取 Token，Token 包含以下信息：
- `sub`: 用户ID
- `tenant_id`: 租户ID（系统管理员为 null）
- `is_system_admin`: 是否是系统管理员
- `is_tenant_admin`: 是否是租户管理员

## 接口列表

### 1. 认证接口

#### 1.1 用户登录

**接口地址**: `POST /auth/login`

**接口描述**: 用户通过手机号和密码登录系统

**请求参数**:

```json
{
  "phone": "13800138000",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**说明**:
- 系统会根据手机号自动识别用户所属租户
- 系统管理员和租户用户使用统一登录接口

---

### 2. 当前用户接口

#### 2.1 获取当前用户信息

**接口地址**: `GET /me`

**接口描述**: 获取当前登录用户的信息

**请求头**: 需要携带 Token

**响应示例**:

```json
{
  "id": "user-id",
  "tenant_id": "tenant-id",
  "username": "admin",
  "phone": "13800138000",
  "status": "active",
  "is_tenant_admin": false,
  "is_system_admin": true,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

#### 2.2 获取当前用户权限

**接口地址**: `GET /me/permissions`

**接口描述**: 获取当前用户的所有权限列表

**请求头**: 需要携带 Token

**响应示例**:

```json
[
  {
    "code": "system:user:create",
    "name": "创建用户",
    "type": "button"
  },
  {
    "code": "system:user:read",
    "name": "查看用户",
    "type": "menu"
  }
]
```

---

### 3. 系统管理员接口

#### 3.1 检查系统管理员是否存在

**接口地址**: `GET /system-admin/exists`

**接口描述**: 检查系统中是否已存在系统管理员

**响应示例**:

```json
{
  "exists": true
}
```

#### 3.2 初始化系统管理员

**接口地址**: `POST /system-admin/init`

**接口描述**: 初始化系统管理员账号（仅首次使用）

**请求参数**:

```json
{
  "username": "admin",
  "phone": "13800138000",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名 |
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "message": "系统管理员创建成功"
}
```

**说明**:
- 系统管理员只能创建一次
- 创建后会自动分配"系统管理员"角色

---

### 4. 租户管理接口

#### 4.1 创建租户

**接口地址**: `POST /tenants`

**接口描述**: 创建新租户（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "code": "TENANT001",
  "name": "示例租户",
  "description": "租户描述"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 租户编码（全局唯一） |
| name | string | 是 | 租户名称（全局唯一） |
| description | string | 否 | 租户描述 |

**响应示例**:

```json
{
  "id": "tenant-id",
  "code": "TENANT001",
  "name": "示例租户",
  "description": "租户描述",
  "status": true,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

#### 4.2 查询租户列表

**接口地址**: `GET /tenants`

**接口描述**: 查询租户列表（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| status | bool | 否 | 状态过滤（true-启用，false-停用） |

**响应示例**:

```json
[
  {
    "id": "tenant-id",
    "code": "TENANT001",
    "name": "示例租户",
    "status": true
  }
]
```

#### 4.3 查询单个租户

**接口地址**: `GET /tenants/{tenant_id}`

**接口描述**: 查询单个租户详情（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| tenant_id | string | 租户ID |

#### 4.4 更新租户

**接口地址**: `PUT /tenants/{tenant_id}`

**接口描述**: 更新租户信息（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "name": "新租户名称",
  "description": "新描述"
}
```

#### 4.5 删除租户

**接口地址**: `DELETE /tenants/{tenant_id}`

**接口描述**: 删除租户（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

#### 4.6 启用/停用租户

**接口地址**: `PATCH /tenants/{tenant_id}/status`

**接口描述**: 启用或停用租户（仅系统管理员）

**请求头**: 需要携带 Token（系统管理员）

**请求参数**:

```json
{
  "status": true
}
```

---

### 5. 用户管理接口

#### 5.1 创建用户

**接口地址**: `POST /users`

**接口描述**: 创建新用户

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "username": "user001",
  "phone": "13800138001",
  "password": "password123"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 是* | 租户ID（系统管理员必填，租户管理员自动使用其tenant_id） |
| username | string | 是 | 用户名（租户内唯一） |
| phone | string | 是 | 手机号（全局唯一） |
| password | string | 是 | 密码（至少6个字符） |

**响应示例**:

```json
{
  "id": "user-id",
  "tenant_id": "tenant-id",
  "username": "user001",
  "phone": "13800138001",
  "status": "active",
  "is_tenant_admin": false,
  "is_system_admin": false,
  "created_at": "2025-01-01T00:00:00",
  "updated_at": "2025-01-01T00:00:00"
}
```

**权限说明**:
- 系统管理员：可以为任意租户创建用户
- 租户管理员：只能为本租户创建用户（tenant_id 自动填充）

#### 5.2 查询用户列表

**接口地址**: `GET /users`

**接口描述**: 查询用户列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 是 | 租户ID（系统管理员必填，租户管理员自动使用其tenant_id） |
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| status | string | 否 | 状态过滤（active-启用，frozen-冻结） |

**权限说明**:
- 系统管理员：必须指定 tenant_id，可以查看任意租户的用户
- 租户管理员：自动使用其 tenant_id，只能查看本租户的用户

#### 5.3 查询单个用户

**接口地址**: `GET /users/{user_id}`

**接口描述**: 查询单个用户详情

**请求头**: 需要携带 Token

**权限说明**:
- 系统管理员：可以查看任意用户
- 租户管理员：只能查看本租户的用户

#### 5.4 更新用户

**接口地址**: `PUT /users/{user_id}`

**接口描述**: 更新用户信息

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "username": "new-username",
  "phone": "13800138002",
  "password": "new-password",
  "status": "active",
  "tenant_id": "tenant-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 否 | 用户名 |
| phone | string | 否 | 手机号 |
| password | string | 否 | 密码（留空则不修改） |
| status | string | 否 | 状态（active/frozen） |
| tenant_id | string | 否 | 租户ID（仅系统管理员可修改） |

**权限说明**:
- 系统管理员：可以修改任意用户信息，包括 tenant_id
- 租户管理员：只能修改本租户的用户信息，不能修改 tenant_id

#### 5.5 删除用户

**接口地址**: `DELETE /users/{user_id}`

**接口描述**: 删除用户

**请求头**: 需要携带 Token

**权限说明**:
- 系统管理员：可以删除任意用户
- 租户管理员：只能删除本租户的用户

#### 5.6 启用/冻结用户

**接口地址**: `PATCH /users/{user_id}/status`

**接口描述**: 启用或冻结用户

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "status": "active"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | string | 是 | 状态（active-启用，frozen-冻结） |

---

### 6. 角色管理接口

#### 6.1 创建角色

**接口地址**: `POST /roles`

**接口描述**: 创建新角色

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "tenant_id": "tenant-id",
  "name": "角色名称",
  "description": "角色描述",
  "status": true
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | string | 否 | 租户ID（None表示系统级角色，仅系统管理员可创建） |
| name | string | 是 | 角色名称（租户内唯一） |
| description | string | 否 | 角色描述 |
| status | bool | 否 | 状态（默认true） |

**权限说明**:
- 系统管理员：可以创建系统级角色（tenant_id为None）或租户级角色
- 租户管理员：只能创建租户级角色（tenant_id自动填充）

#### 6.2 查询角色列表

**接口地址**: `GET /roles`

**接口描述**: 查询角色列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| status | bool | 否 | 状态过滤 |

**权限说明**:
- 系统管理员：可以查看所有角色（系统级和租户级）
- 租户管理员：只能查看本租户的角色和系统级角色

#### 6.3 查询单个角色

**接口地址**: `GET /roles/{role_id}`

**接口描述**: 查询单个角色详情

**请求头**: 需要携带 Token

#### 6.4 更新角色

**接口地址**: `PUT /roles/{role_id}`

**接口描述**: 更新角色信息

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "name": "新角色名称",
  "description": "新描述",
  "status": true
}
```

#### 6.5 删除角色

**接口地址**: `DELETE /roles/{role_id}`

**接口描述**: 删除角色

**请求头**: 需要携带 Token

#### 6.6 为角色分配权限

**接口地址**: `POST /roles/{role_id}/permissions`

**接口描述**: 为角色分配权限

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "permission_ids": ["permission-id-1", "permission-id-2"]
}
```

**权限说明**:
- 系统级角色：可以分配任意权限
- 租户级角色：只能分配系统级权限或本租户的权限

#### 6.7 为角色分配用户

**接口地址**: `POST /roles/{role_id}/users`

**接口描述**: 为角色分配用户

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "user_ids": ["user-id-1", "user-id-2"]
}
```

**权限说明**:
- 系统级角色：可以分配给任意租户的用户
- 租户级角色：只能分配给本租户的用户

#### 6.8 获取角色的权限列表

**接口地址**: `GET /roles/{role_id}/permissions`

**接口描述**: 获取角色已分配的权限列表

**请求头**: 需要携带 Token

#### 6.9 获取角色的用户列表

**接口地址**: `GET /roles/{role_id}/users`

**接口描述**: 获取角色已分配的用户列表

**请求头**: 需要携带 Token

#### 6.10 为用户分配角色

**接口地址**: `POST /users/{user_id}/roles`

**接口描述**: 为用户分配角色

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "role_ids": ["role-id-1", "role-id-2"]
}
```

**权限说明**:
- 系统级角色：可以分配给任意租户的用户
- 租户级角色：只能分配给本租户的用户

---

### 7. 权限管理接口

#### 7.1 创建权限

**接口地址**: `POST /permissions`

**接口描述**: 创建新权限

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "code": "system:resource:action",
  "name": "权限名称",
  "description": "权限描述",
  "type": "menu",
  "module": "system",
  "tenant_id": "tenant-id"
}
```

**参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 权限编码（全局唯一，格式：module:resource:action） |
| name | string | 是 | 权限名称 |
| description | string | 否 | 权限描述 |
| type | string | 是 | 权限类型（menu/api/button） |
| module | string | 是 | 所属模块 |
| tenant_id | string | 否 | 租户ID（None表示系统级权限） |

#### 7.2 查询权限列表

**接口地址**: `GET /permissions`

**接口描述**: 查询权限列表

**请求头**: 需要携带 Token

**查询参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| skip | int | 否 | 跳过条数（默认0） |
| limit | int | 否 | 返回条数（默认100） |
| module | string | 否 | 模块过滤 |
| type | string | 否 | 类型过滤（menu/api/button） |
| status | bool | 否 | 状态过滤 |

**权限说明**:
- 系统管理员：可以查看所有权限
- 租户管理员：可以查看系统级权限和本租户的权限，但会过滤掉租户管理相关权限（system:tenant:*）

#### 7.3 查询单个权限

**接口地址**: `GET /permissions/{permission_id}`

**接口描述**: 查询单个权限详情

**请求头**: 需要携带 Token

#### 7.4 更新权限

**接口地址**: `PUT /permissions/{permission_id}`

**接口描述**: 更新权限信息

**请求头**: 需要携带 Token

#### 7.5 删除权限

**接口地址**: `DELETE /permissions/{permission_id}`

**接口描述**: 删除权限

**请求头**: 需要携带 Token

#### 7.6 启用/停用权限

**接口地址**: `PATCH /permissions/{permission_id}/status`

**接口描述**: 启用或停用权限

**请求头**: 需要携带 Token

**请求参数**:

```json
{
  "status": true
}
```

---

## 错误码说明

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（Token无效或过期） |
| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 错误响应格式

```json
{
  "detail": "错误描述信息"
}
```

### 常见错误

1. **401 Unauthorized**: Token 无效或过期，需要重新登录
2. **403 Forbidden**: 无权限访问该资源
3. **400 Bad Request**: 请求参数错误，如：
   - 手机号已被占用
   - 用户名在租户内已存在
   - 租户编码已存在
   - 密码格式不正确

---

## 数据模型

### 用户（User）

```json
{
  "id": "string",
  "tenant_id": "string | null",
  "username": "string",
  "phone": "string",
  "status": "active | frozen",
  "is_tenant_admin": false,
  "is_system_admin": false,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 租户（Tenant）

```json
{
  "id": "string",
  "code": "string",
  "name": "string",
  "description": "string | null",
  "status": true,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 角色（Role）

```json
{
  "id": "string",
  "tenant_id": "string | null",
  "name": "string",
  "description": "string | null",
  "status": true,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 权限（Permission）

```json
{
  "id": "string",
  "code": "string",
  "name": "string",
  "description": "string | null",
  "type": "menu | api | button",
  "module": "string",
  "tenant_id": "string | null",
  "status": true,
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

---

## 注意事项

1. **Token 有效期**: Token 默认有效期为 24 小时，过期后需要重新登录
2. **租户隔离**: 所有数据查询都强制进行租户隔离，租户管理员只能访问本租户的数据
3. **手机号唯一性**: 手机号在整个系统中必须唯一
4. **用户名唯一性**: 用户名在同一租户内必须唯一
5. **角色分配**: 为用户分配角色后，系统会自动更新用户的 `is_tenant_admin` 状态
6. **系统管理员判断**: 系统通过检查用户是否有"系统管理员"角色来判断是否是系统管理员

---

## 接口测试

可以使用以下工具测试接口：

1. **Swagger UI**: 访问 `http://localhost:8000/docs` 查看交互式 API 文档
2. **Postman**: 导入接口文档进行测试
3. **curl**: 使用命令行工具测试

### 示例：使用 curl 登录

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "password123"
  }'
```

### 示例：使用 curl 获取用户列表

```bash
curl -X GET "http://localhost:8000/api/v1/users?tenant_id=tenant-id" \
  -H "Authorization: Bearer <token>"
```
