---
name: doc-module-plan
overview: 设计文档管理模块（上传/解析/标签/权限/版本与覆盖策略）
todos: []
---

# 文档管理模块计划

## 范围确认

- 支持 TXT、Markdown、PDF、Word 上传解析；允许上传类型可配置（系统管理统一配置），初始白名单：txt、md、pdf、word
- 存储：先本地/网盘，预留对象存储（S3/OSS/MinIO）抽象
- 版本策略：版本号规则 V数字+1；同名冲突提示并按用户选择处理；回滚与差异查看本期不做（预留接口）
- 权限码命名规范：遵循 module:resource:action 格式（如 doc:file:read、doc:file:upload、doc:folder:create 等）
- 配置项归属：上传类型（可上传文件类型）、文件大小上限（可上传的单个文件的大小）、文本切分策略在系统管理的配置管理模块中统一管理；文本切分策略属于配置管理模块，文档管理模块读取和使用系统/租户级配置，用户可在文档管理模块中配置用户级配置项
- 用户配置存储：用户级配置存储在用户配置表（DDD 角度），持久化，立即生效；不在配置管理模块中；用户配置表结构后边再定
- 文件-用户-配置关系：用户配置是针对文件的，同一用户上传不同文件时，可以有不同的配置；每个文件保存自己的配置（文件-配置一对一），用户有"最近使用的配置"作为默认值；用户为文件配置后自动更新"最近使用的配置"；删除文件时配置也删除，不影响"最近使用的配置"
- 标签：属于用户，无全局标签；用户可在文件上定义多个 tag，支持按 tag 模糊搜索

## 决策澄清

- 上传类型：初始白名单 txt、md、pdf、word；文件大小上限三层配置（系统/租户/用户），单文件默认50M，总容量不限制
- 解析器：统一解析为 markdown 格式；解析完的文件需存储（原文件 + markdown 结果）；解析失败重试3次，保留失败状态，加入待办表
- 存储抽象：文件系统/对象存储抽象（默认文件系统），markdown 不支持查看/编辑；路径隔离：租户id+用户id+用户自己建的文件夹的每一层级的id
- 文件夹管理：层级深度根目录+2层子文件夹（共3层）；文件夹权限与文件一致（读/写/删除），只有拥有者可以看到文件夹（控制是否显示在列表中），文件可通过直接链接访问；文件夹删除需二次确认+输入确认文字"我确认删除某某文件夹"；文件夹移动预留接口
- 版本管理：版本号 V1、V2...递增；版本历史不限制数量，可手动删除（仅所有者），不影响当前版本；新版本解析成功后再删除旧版本索引和向量库数据；同名文件检测在当前文件夹，前端调用后端接口；选择"使用已有文件"则不允许上传；回滚与差异查看预留接口
- 标签模型：标签属于用户，无全局标签；20字以内，无命名规范；下拉选择+新增，自动补全（基于历史标签），新标签立即加入下拉选项；仅在使用时显示，删除时自动移除，保留历史记录
- 文本切分策略：系统/租户/用户三层配置，逐层覆盖，只覆盖用户修改的配置项；可配置项：文字长度切分（chunk 400，overlap 100）、按段落智能分、按关键字分（用户输入单个关键字，按字符 split）；属于配置管理模块，文档管理模块读取和使用系统/租户级配置，用户可在文档管理模块中配置用户级配置项；只影响单个文件；配置的生效时机：立即生效
- 向量化处理：解析完成后异步处理；向量化完成后才显示已完成，进行中显示处理中；向量化失败显示为解析失败，不允许手动重试，加入待办表
- 文档状态：上传中、上传成功、解析中、完成、上传失败、解析失败
- 安全/合规：病毒扫描、敏感词检测预留接口；删除做逻辑删除，但向量库索引需同步删除；删除时等待处理完成；删除后引用提示失效；软删除恢复后需要重新向量化
- 待办表：解析/向量化失败待办表（同一张表），字段包含文档ID、失败原因、失败时间、重试次数、JSON任务字段（区分任务类型），每小时扫描，删除待办；预留接口
- 文件夹与知识库：文件夹就是知识库；选择时包含所有子文件夹；支持多选；检索结果按相似度排序，不考虑去重
- 分享功能：不做，但权限预留

## 实施要点

1) 上传与解析

- MIME 校验、大小/类型限制（初始白名单：txt、md、pdf、word，单文件默认50M）；按文件类型选择解析器（策略/工厂模式）
- 用户配置界面：用户上传文档时直接配置，先把配置项填好（文本切分策略等），然后上传文件；配置项如果不填的话默认用的就是租户的配置项；默认使用用户上次使用的配置，可以重新填写
- 同名文件检测：前端调用后端接口，用户选择文件后检测，确认后提交；选择"使用已有文件"则不允许上传
- 统一解析为 markdown 格式；内容清洗（去 BOM、统一编码、去危险标签）
- 存储原文件 + markdown 解析结果（存储抽象：文件系统/对象存储，不支持查看/编辑）；抽取标题/摘要/分段用于索引
- 解析失败：重试3次，保留失败状态，加入待办表；手动只能删除文件重新上传
- 文档状态：上传中、上传成功、解析中、完成、上传失败、解析失败

2) 存储抽象

- 存储接口封装：本地/对象存储实现可插拔（默认文件系统）；生成可公开/受控的访问 URL
- 路径隔离：租户id+用户id+用户自己建的文件夹的每一层级的id
- 元数据表：文件名、hash、大小、类型、存储位置、版本号、标签、所属租户/用户、创建时间、修改时间、页数
- 元数据不支持手动编辑

3) 版本与覆盖

- 同名检测：提示并选择 a) 覆盖新版本（旧版留存，版本号 V1、V2...递增） b) 使用已有文件（不允许上传）
- 版本管理：版本号递增，记录操作者、时间、备注；版本历史不限制数量，可手动删除（仅所有者），不影响当前版本
- 版本覆盖：新版本解析成功后再删除旧版本索引和向量库数据；只保留当前使用版本的索引
- 回滚与差异查看：本期不做，预留接口（空方法）

4) 标签与查询

- 标签属于用户，无全局标签；用户可在文件上定义多个 tag（20字以内，无命名规范）
- 标签输入：下拉选择+新增，自动补全（基于历史标签），新标签立即加入下拉选项；仅在使用时显示，保留历史记录
- 标签 CRUD，删除时自动移除；按 tag 模糊搜索 + 关键词查询、排序
- 软删除与回收站；逻辑删除时同步删除向量库索引；恢复后需要重新向量化

5) 权限与审计

- 权限码命名规范：遵循 module:resource:action 格式（如 doc:file:read、doc:file:upload、doc:folder:create 等）
- 资源级权限：文件/文件夹的读写删、分享（分享功能不做，权限预留）；租户隔离，角色/用户授权
- 文件夹权限：只有拥有者可以看到文件夹（控制是否显示在列表中），文件可通过直接链接访问；文件夹权限与文件一致
- 文档删除：等待处理完成再删除；删除后引用提示失效；删除文件时配置也删除，不影响"最近使用的配置"
- 审计：上传/下载/删除/标签变更日志（用户、租户、时间、结果、IP/UA）；标签删除记录操作日志；配置项的审计日志：管理员、租户记录，用户不记录
- 最小操作日志：必须记录（用户的每一个操作都需要记录日志），后续审计接口中做开关判断

6) 向量化与索引

- 向量化触发：解析完成后异步处理；向量化完成后才显示已完成，进行中显示处理中；向量化失败显示为解析失败
- 文本切分策略：系统/租户/用户三层配置，逐层覆盖，只覆盖用户修改的配置项；可配置项：文字长度切分（chunk 400，overlap 100）、按段落智能分、按关键字分（用户输入单个关键字，按字符 split）；属于配置管理模块，文档管理模块读取和使用系统/租户级配置，用户可在文档管理模块中配置用户级配置项；只影响单个文件；配置的生效时机：立即生效
- 向量化失败：不允许手动重试，加入待办表
- 索引同步：文档删除/更新时异步执行删除/更新；文件夹删除时同步删除内部所有文件的向量库索引

7) 文件夹管理

- 文件夹层级：根目录+2层子文件夹（共3层）；根目录下可创建多个文件夹
- 文件夹操作：支持重命名，移动预留接口；删除需二次确认+输入确认文字"我确认删除某某文件夹"
- 文件夹删除：如果内部文件正在解析中，取消任务并删除；异步删除向量库索引
- 文件夹与知识库：文件夹就是知识库；选择时包含所有子文件夹；支持多选；检索结果按相似度排序，不考虑去重

8) 文档操作与导出

- 下载/预览接口（预览预留接口）；可配置导出水印/防直链
- 批量操作（删除、打标、导出）预留接口，需权限校验

9) 性能与可靠性（增强）

- 大文件分片上传/断点续传；并发/速率限制
- 幂等：hash 去重、重试安全；病毒/敏感词扫描预留接口（本期不做）
- 待办表：解析/向量化失败待办表（同一张表），字段包含文档ID、失败原因、失败时间、重试次数、JSON任务字段（区分任务类型），每小时扫描，删除待办；预留接口

## 交付物

- 后端：文档/版本/标签/权限/审计接口与模型，存储适配层（文件系统/对象存储抽象），解析器抽象（统一输出 markdown），文本切分策略配置（读取配置管理模块配置，用户可配置用户级配置项），待办表管理，用户配置表（文件-配置关系）
- 前端：上传/列表/标签/版本时间线/权限分配的页面，文件夹管理（创建/删除/重命名），文档状态展示，标签下拉选择+自动补全，用户配置界面（上传文档时配置文本切分策略等），文件列表显示每个文件使用的配置项（回滚与差异查看、预览、批量操作、文件夹移动预留接口）
- 文档：数据模型、权限矩阵、流程（上传-解析-存储-版本/权限）、审计字段、文档状态流转图、文本切分策略配置说明、文件-用户-配置关系说明