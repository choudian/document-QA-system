---
name: system-admin-module
overview: 系统管理模块（租户/用户/角色/菜单、AI配置分层、日志与审计）
todos: []
---

# 系统管理模块落地计划

## 范围确认

- 认证：先账号+密码，SSO/OIDC 仅预留空方法；可选 MFA（短信/邮箱/OTP）
- 审计：本期不做，实现占位接口
- 多租户：逻辑字段强制租户隔离（查询全局强制 tenant_id），租户管理员可授权
- 权限粒度：菜单、接口、按钮、Tab 页

## 决策澄清

- 租户隔离：tenant_id 全局拦截 + 租户级唯一约束（如 tenant_id + username）
- 权限模型：默认角色模板（平台管理员、租户管理员、成员、访客）；权限码命名规范遵循 module:resource:action 格式，区分平台级/租户级命名空间
- 菜单/路由：前端路由与权限码绑定；支持动态菜单拉取，保留本地白名单兜底
- AI 配置分层：系统 -> 租户 -> 用户，用户不能查看租户的默认配置；密钥展示首尾各 4 位；密钥加密存储，最小操作日志（谁在何时改动）
- 配置继承：下级覆盖上级，没有禁用概念；系统级配置必须有默认值；子级不配置时使用父级配置
- 配置可见性：配置管理模块中，租户管理员可以看到系统级配置的默认值（作为初始值显示）；使用界面中，普通用户看不到系统/租户的默认值，只能自己配置；敏感信息（如密钥）即使租户管理员也看不到系统级的完整密钥，只能看到首尾各 4 位
- 可用性探测：密钥/提供商可用性需探测，但本期仅预留接口
- 额度/速率：本期不做，实现占位接口

## 实施步骤

1) 认证与会话

- 登录/注册/重置密码，密码加密存储，MFA 开关
- 会话与刷新机制（JWT/Session），租户上下文注入，限流与锁定策略
- SSO/OIDC 占位接口（空实现），便于后续接入

2) 租户/用户管理

- 租户实体与状态（启用/停用）；租户维度的用户 CRUD、邀请/导入
- 租户管理员赋权路径，用户状态（启用/冻结）、密码重置
- 唯一约束与隔离：tenant_id + username 唯一；全局查询拦截确保强制带 tenant_id
- 三种管理角色：系统管理员（整个系统就只有一个，作用是超管，配置整个系统的默认配置，创建租户以及租户的账号，只管理租户本身）；租户管理员（配置角色、权限、配置项、创建用户、授权等，只能管理用户账号）；普通用户（上传文档，问答，配置）

3) 角色与权限

- RBAC：租户下角色管理；菜单/接口/按钮/Tab 授权
- 默认角色模板（平台管理员、租户管理员、成员、访客）
- 权限码命名规范遵循 module:resource:action 格式，平台级与租户级空间区分；权限校验中间件

4) 菜单与资源管理

- 菜单/功能点配置、排序、显隐；绑定权限标识
- 权限驱动的前端路由/按钮显隐与后端授权拦截

5) AI 服务提供商配置

- 支持 OpenAI/Claude/本地模型等多提供商，配置项含 key、baseUrl、模型列表
- 配置层级：系统默认 -> 租户覆盖 -> 用户覆盖；用户不能查看租户的默认配置；密钥展示首尾各 4 位
- 安全存储（加密、脱敏展示）、最小操作日志；可用性探测接口预留

6) 配置管理模块

- 配置项清单：模型配置、重排序模型、向量化模型（2层：系统/租户）、向量库（2层：系统/租户）、可上传文件类型、可上传的单个文件的大小、文本切分策略、相似度、TopK等；配置项需要分类管理（模型相关、存储相关、文档相关、问答相关等），分组展示
- 配置层级：向量化模型和向量库为2层（系统/租户），其他配置为3层（系统/租户/用户）
- 配置生效范围：向量化模型、向量库影响租户内所有用户上传文件时使用的向量化模型、向量库；文本切分策略等只影响单个文件
- 配置可见性：租户管理员在配置管理模块中可以看到系统级配置的默认值（作为初始值显示），修改后成为租户级配置；普通用户在文档/问答界面做覆盖配置，看不到系统/租户的默认值；某些特定的配置项普通用户看不到
- 配置存储：用户级配置存储在用户配置表（DDD角度），系统/租户级配置存储在系统配置表（用 tenant_id 字段区分系统级和租户级），持久化，下次自动加载；用户配置表结构后边再定
- 配置继承和覆盖：系统级 -> 租户级 -> 用户级逐层覆盖，只覆盖用户修改的配置项；租户的默认值就是系统级的配置；如果租户没有配置，使用系统级配置
- 配置的生效时机：立即生效
- 用户配置方式：用户上传文档时直接配置，先把配置项填好，然后上传文件；配置项如果不填的话默认用的就是租户的配置项；用户首次使用时默认使用租户级配置
- 用户配置存储方式：A+B方案，每个文件保存自己的配置（文件-配置一对一），用户有"最近使用的配置"作为默认值；用户为文件配置后自动更新"最近使用的配置"；删除文件时配置也删除，不影响"最近使用的配置"；"最近使用的配置"保持不变
- 用户配置查看：文件列表中显示每个文件使用的配置项；用户可以查看自己之前为不同文件配置的配置项历史，不可以修改
- 配置项的删除和重置：不可以删除，重置就是用户这次操作的时候改一下，下次就用这次的配置了
- 配置项的版本管理：需要历史记录（数据级的，业务上没关系），不支持回滚
- 配置项的验证规则：预留接口以及空方法，这次先不做
- 配置项的导入导出：所有导出的都预留，不做
- 配置项的备份和恢复：不可以
- 配置项的迁移：没有迁移功能
- 配置项的依赖关系：不依赖
- 配置项的冲突处理：使用低级的覆盖
- 配置项的查询和统计：租户管理员不能查看租户内用户使用的配置项统计
- 配置项的审计日志：管理员、租户记录，用户不记录
- 权限：平台管理员、租户管理员可以访问配置管理模块；普通用户配置用户级配置项需要特殊权限，默认所有的用户都可以配置；权限码命名规范（如 system:config:read、system:config:update），不做系统级和租户级区分

7) 日志与审计

- 本期不实现审计，保留接口；最小操作日志必须记录（用户的每一个操作都需要记录日志，包括密钥更新、配置修改、文件上传/删除、标签变更等），通过公共组件实现（AOP 切面拦截 controller 注解），后续审计接口中做开关判断
- 对话性能与模型调用日志：耗时、token、错误率；Langfuse 接入预留（trace/span/score）

8) 监控与额度控制（占位）

- 额度/并发/速率限制占位接口，未实现
- Langfuse 指标/仪表盘作为后续选项

## 交付物

- 后端：租户/用户/角色/菜单/权限/AI提供商配置/配置管理模块/日志的接口与模型，用户配置表、系统配置表（用 tenant_id 区分系统级和租户级），最小操作日志公共组件（AOP 切面），配置项历史记录表
- 前端：对应管理页面（列表/表单/授权分配）与权限路由，配置管理模块表单页（配置项分类分组展示）
- 文档：数据模型、权限矩阵、操作/审计字段定义、配置管理模块配置项清单、三种管理角色权限说明