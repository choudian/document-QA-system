# 设计假设和约束

本文档说明系统设计中的关键假设、约束和决策。

## 1. 业务假设

### 1.1 多租户模型

**假设**：
- 系统需要支持多个租户（组织/公司）
- 每个租户的数据完全隔离
- 租户管理员可以管理本租户的用户和配置
- 系统管理员可以管理所有租户

**影响**：
- 所有数据表都包含 `tenant_id` 字段
- 所有查询都强制过滤 `tenant_id`
- 系统管理员 `tenant_id` 为 `NULL`

### 1.2 用户模型

**假设**：
- 用户通过手机号登录（全局唯一）
- 系统自动识别用户所属租户
- 用户可以是系统管理员、租户管理员或普通用户
- 用户角色通过角色表关联，而非直接字段

**影响**：
- 手机号全局唯一约束
- 登录时自动识别租户
- 权限通过角色-权限关联表管理

### 1.3 文档管理

**假设**：
- 文档属于用户，用户只能访问自己的文档
- 文档可以组织到文件夹中（最多3层）
- 文件夹就是知识库，用于问答检索
- 文档支持版本管理，新版本覆盖旧版本

**影响**：
- 文档表包含 `user_id` 和 `folder_id`
- 文件夹层级限制为3层
- 版本管理需要异步清理旧版本向量数据

### 1.4 问答功能

**假设**：
- 用户可以选择多个知识库（文件夹）进行检索
- 检索结果需要重排序以提高准确性
- 支持多轮对话，保持上下文
- 引用来源需要显示文档名称而非ID

**影响**：
- 检索时需要补充文档信息到metadata
- 上下文管理需要Token限制和智能裁剪（待完善）

## 2. 技术假设

### 2.1 数据库

**假设**：
- 生产环境使用PostgreSQL
- 开发环境可以使用SQLite
- 数据库支持JSON字段（用于存储配置、元数据）

**影响**：
- 使用SQLAlchemy ORM，支持多种数据库
- JSON字段用于灵活存储配置

### 2.2 向量存储

**假设**：
- 使用ChromaDB作为向量数据库
- 向量维度为1536（OpenAI embedding）
- 向量数据需要按租户、用户、文件夹隔离

**影响**：
- 向量库路径包含 `tenant_id`、`user_id`、`folder_id`
- 检索时需要构建正确的路径

### 2.3 LLM集成

**假设**：
- 支持OpenAI兼容API格式
- 支持自定义 `base_url`（可对接阿里云等）
- 流式输出使用SSE格式

**影响**：
- 使用LangChain统一接口
- 支持多种模型提供商

### 2.4 文件存储

**假设**：
- 默认使用文件系统存储
- 未来可能迁移到对象存储（S3/OSS）
- 存储路径需要隔离（租户/用户/文件夹）

**影响**：
- 使用存储抽象层，便于切换实现
- 路径格式：`{tenant_id}/{user_id}/{folder_id}/...`

## 3. 性能假设

### 3.1 并发

**假设**：
- 单租户用户数：10-1000人
- 单用户文档数：100-10000个
- 并发请求：< 100 req/s

**影响**：
- 当前未实现限流，未来需要添加
- 数据库连接池大小：10-20

### 3.2 数据量

**假设**：
- 单文档大小：< 50MB
- 单租户文档总数：< 100万
- 向量数据：每个chunk约1KB向量

**影响**：
- 文件上传大小限制：50MB
- 向量化批量处理：每批100个chunk

### 3.3 响应时间

**假设**：
- API响应时间：< 500ms（非向量化操作）
- 文档解析：< 30秒（取决于文档大小）
- 向量化：< 5分钟（取决于文档大小和chunk数量）

**影响**：
- 文档解析和向量化采用异步处理
- 用户界面显示处理状态

## 4. 安全假设

### 4.1 认证

**假设**：
- 使用JWT Token，无状态认证
- Token有效期：30分钟
- 密码最小长度：6个字符

**影响**：
- 每次请求都需要验证Token
- Token存储在localStorage（前端）

### 4.2 授权

**假设**：
- 使用RBAC模型
- 权限码格式：`module:resource:action`
- 权限缓存：内存缓存，5分钟过期

**影响**：
- 所有API端点都需要权限校验
- 权限检查通过中间件实现

### 4.3 数据加密

**假设**：
- 密码使用bcrypt哈希（cost=12）
- 敏感配置（API Key）Base64编码存储
- 传输使用HTTPS（生产环境）

**影响**：
- 密码不可逆，只能重置
- API Key需要解密后才能使用

## 5. 可用性假设

### 5.1 服务可用性

**假设**：
- 数据库可用性：99.9%
- 向量库可用性：99.9%
- LLM服务可用性：依赖第三方（OpenAI/阿里云）

**影响**：
- 需要处理服务不可用的情况
- LLM调用失败需要友好提示

### 5.2 数据一致性

**假设**：
- 文档上传和解析需要保证一致性
- 版本覆盖需要保证原子性
- 向量化失败不影响文档存储

**影响**：
- 使用数据库事务保证一致性
- 向量化失败记录到待办表

## 6. 扩展性假设

### 6.1 水平扩展

**假设**：
- 后端服务可以水平扩展（无状态）
- 数据库可以读写分离
- 向量库可以分片

**影响**：
- 当前为单体应用，未来可拆分为微服务
- 使用共享存储（数据库、向量库）

### 6.2 功能扩展

**假设**：
- 需要支持更多文档格式（Excel、PPT等）
- 需要支持更多向量库（Milvus、PGVector等）
- 需要支持更多LLM提供商

**影响**：
- 使用工厂模式，易于扩展
- 配置化，无需修改代码

## 7. 开发假设

### 7.1 开发环境

**假设**：
- 开发使用Python 3.11+
- 使用uv或pip管理依赖
- 前端使用Node.js 20+

**影响**：
- 代码兼容Python 3.9+（向后兼容）
- 使用现代Python特性（类型提示、异步）

### 7.2 代码质量

**假设**：
- 需要单元测试覆盖
- 需要代码审查
- 需要文档完善

**影响**：
- 使用pytest进行测试
- 代码注释和文档齐全

## 8. 部署假设

### 8.1 部署环境

**假设**：
- 支持Docker部署
- 支持Kubernetes部署（未来）
- 支持云平台部署（AWS、阿里云等）

**影响**：
- 提供Dockerfile和docker-compose.yml
- 环境变量配置化

### 8.2 数据备份

**假设**：
- 数据库需要定期备份
- 文档文件需要备份
- 向量库数据需要备份

**影响**：
- 当前未实现自动备份，需要手动配置
- 建议使用云平台备份服务

## 9. 限制和约束

### 9.1 已知限制

1. **上下文管理**: 当前只取最近5条消息，未实现Token限制和智能裁剪
2. **Langfuse集成**: 配置完成但未实际使用
3. **单元测试**: 覆盖率约50%，部分模块未覆盖
4. **性能优化**: 未实现缓存、限流等优化

### 9.2 技术债务

1. **代码重构**: 部分服务类方法过长
2. **错误处理**: 可以更统一
3. **日志记录**: 可以更规范
4. **文档完善**: 缺少架构图、流程图

## 10. 未来改进方向

### 10.1 短期（1-3个月）

- 完善上下文管理（Token限制、智能裁剪）
- Langfuse实际集成
- 提高测试覆盖率到80%+
- 添加性能监控

### 10.2 中期（3-6个月）

- 微服务化拆分
- 消息队列集成
- 分布式追踪
- 缓存机制

### 10.3 长期（6-12个月）

- AI Agent支持
- 多模态支持（图片、音频）
- 实时协作
- 移动端支持
