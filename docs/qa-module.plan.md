---
name: qa-module-plan
overview: 设计问答模块（多轮对话、会话管理、检索配置、向量库/模型抽象、隔离与权限）
todos: []
---

# 问答模块计划

## 范围确认

- 多轮对话保持上下文；一个用户多会话，会话内消息可删除
- 检索式回答需展示引用片段/链接
- LLM：当前流式回答，预留工具/Agent 接口（未来扩展函数调用/插件）
- 配置分层：系统默认 -> 租户覆盖 -> 用户覆盖；对话可选知识库
- 文件/知识库隔离：支持文件夹/空间隔离；租户与用户权限
- 向量库与重排序可插拔，租户级配置并可在会话侧调整（topK、相似度阈值、重排模型）

## 实施要点

1) 会话与消息

- 数据模型：会话（用户、租户、标题、创建/更新时间、状态）；消息（role/content/引用/向量检索结果、token 统计）
- 会话上下文裁剪：token 上限、摘要/记忆、最近窗口策略
- 消息删除：软删除标记，更新上下文缓存

2) 检索与知识库选择

- 用户发起对话可选择知识库/文件夹；默认使用租户/用户配置的向量化模型、向量库、重排序模型
- 会话级可配置检索参数（topK、相似度阈值、是否重排、重排 topN）；引用片段返回并展示链接/高亮

3) 向量化、重排与模型配置

- 向量化模型分层配置：系统默认 -> 租户 -> 用户；支持自定义 embedding 模型
- 重排序模型可配置（ColBERT/bge-rerank/内置重排），与检索参数同层级继承
- 向量库适配层：Milvus/PGVector/Chroma/Elastic 抽象；租户/用户隔离（库/索引前缀）
- 索引与分段：与文件夹/知识库关联；更新/删除同步索引

4) 权限与隔离

- 租户隔离；知识库/文件夹的读写删、分享权限
- 对话读取权限（仅本人/被分享）；引用片段需权限校验

5) 质量与安全

- 审计：对话与检索日志（用户、租户、知识库、耗时、token、检索参数）；可写入 Langfuse
- 拦截/策略：预留用户输入与模型输出的内容安全/越权拦截接口（同步/异步），可配置启用与策略集
- 内容安全/越权提示（基础版可先不做强拦截，仅记录或提示）

6) 体验与性能

- 流式输出；请求/检索限流；缓存热门查询（可选）
- 模型不可用降级：回退到系统默认模型或提示
- 预留 Agent/工具调用接口：统一工具协议、可配置启用/禁用

## 交付物

- 后端：会话/消息/知识库/向量库适配/重排与检索/引用接口，配置分层与会话级覆盖逻辑
- 前端：会话列表、消息流、知识库选择、检索参数选择（topK/阈值/是否重排）、引用片段展示，消息删除
- 文档：数据模型、权限矩阵、检索+重排流程、日志字段、Agent 扩展点