# 项目进度记录

本文档记录项目的开发进度，包括已完成的功能和待办事项。

## 最近更新

**2024-12-14** - 完成文档管理模块剩余功能实现

---

## 已完成功能

### 系统管理模块 ✅

#### 基础功能
- ✅ 租户管理（CRUD）
- ✅ 用户管理（CRUD）
- ✅ 角色管理（CRUD）
- ✅ 权限管理（CRUD）
- ✅ 菜单管理（CRUD）
- ✅ 配置管理（系统/租户/用户三级配置）
- ✅ 权限校验中间件
- ✅ 统一错误处理和日志记录

#### 权限与角色
- ✅ RBAC权限模型
- ✅ 默认角色模板（系统管理员、租户管理员、成员）
- ✅ 权限码命名规范（module:resource:action）
- ✅ 菜单权限和API权限分离
- ✅ 权限缓存机制

#### 配置管理
- ✅ 三级配置体系（系统/租户/用户）
- ✅ 配置加密存储
- ✅ 配置脱敏展示
- ✅ Langfuse集成配置
- ✅ Embedding模型配置（支持OpenAI、阿里云）
- ✅ 向量库配置（支持ChromaDB）
- ✅ 文档上传配置
- ✅ 文本切分配置

#### 审计与日志
- ✅ 审计日志中间件
- ✅ 请求/响应记录
- ✅ Langfuse集成（可选）
- ✅ 统一异常处理中间件
- ✅ 控制台日志格式化（彩色输出）

### 文档管理模块 ✅

#### 基础功能
- ✅ 文档上传（支持TXT、Markdown、PDF、Word）
- ✅ 文档解析（统一解析为Markdown）
- ✅ 文档列表查询
- ✅ 文档详情查询
- ✅ 文档删除（软删除）
- ✅ 文档恢复
- ✅ 文档下载
- ✅ 同名文件检测

#### 文件夹管理
- ✅ 文件夹创建（支持2层：根目录/1级）
- ✅ 文件夹列表查询
- ✅ 文件夹更新（重命名）
- ✅ 文件夹删除（二次确认）
- ✅ 文件夹树形结构展示
- ✅ 文件夹权限控制

#### 标签管理
- ✅ 标签创建（自动创建）
- ✅ 标签添加/移除
- ✅ 标签列表查询
- ✅ 按标签搜索文档
- ✅ 标签自动补全

#### 版本管理
- ✅ 版本号管理（V1、V2...）
- ✅ 版本历史查询
- ✅ 版本删除（仅所有者）

#### 向量化功能
- ✅ 文本切分（支持固定长度、段落、关键字三种策略）
- ✅ Embedding生成（支持OpenAI、阿里云）
- ✅ 向量存储（ChromaDB本地文件存储）
- ✅ 三级数据隔离（tenant_id、user_id、folder_id）
- ✅ 向量化状态管理（vectorizing、vectorize_failed）
- ✅ 文档chunk元数据存储

#### 存储抽象
- ✅ 文件系统存储实现
- ✅ 存储接口抽象（预留对象存储支持）
- ✅ 路径隔离（租户/用户/文件夹层级）

#### 解析器
- ✅ 文本解析器
- ✅ Markdown解析器
- ✅ PDF解析器（PyPDF2）
- ✅ Word解析器（python-docx）
- ✅ 解析器工厂模式

#### 用户配置
- ✅ 文档配置（每个文档独立配置）
- ✅ 用户最近使用的配置
- ✅ 配置继承（系统/租户/用户）

#### 前端功能
- ✅ 文档列表页面
- ✅ 文件夹树形展示
- ✅ 文档上传模态框
- ✅ 文档详情模态框
- ✅ 标签管理模态框
- ✅ 文档删除功能
- ✅ 文档下载功能
- ✅ 状态显示（包括向量化状态）

### 技术实现 ✅

#### 后端
- ✅ FastAPI框架
- ✅ SQLAlchemy ORM
- ✅ Alembic数据库迁移
- ✅ 异步文件I/O（asyncio.to_thread）
- ✅ 后台任务处理
- ✅ 统一异常处理
- ✅ 权限中间件

#### 前端
- ✅ React 18 + TypeScript
- ✅ Ant Design UI组件
- ✅ React Router路由
- ✅ Axios HTTP客户端
- ✅ 权限控制（菜单/按钮）

#### 依赖管理
- ✅ uv包管理工具支持
- ✅ requirements.txt兼容

---

## 待办事项

### 文档管理模块待完善

#### 高优先级
- ⏳ **待办表功能** - 解析/向量化失败任务管理
  - 创建DocumentTask模型
  - 失败任务自动加入待办表
  - 管理员查看待办任务接口
  - 定时扫描和清理机制

- ⏳ **版本覆盖逻辑完善** - 新版本解析成功后删除旧版本向量数据
  - 在版本创建时记录旧版本信息
  - 新版本解析成功后触发旧版本清理

- ⏳ **文件夹重命名前端支持** - 前端文件夹树支持重命名操作
  - 双击文件夹名称进入编辑模式
  - 或右键菜单添加重命名选项

#### 中优先级
- ⏳ **文档预览功能** - Markdown预览
  - 实现预览接口返回Markdown内容
  - 前端Markdown渲染组件

- ⏳ **批量操作** - 批量删除、批量打标、批量导出
  - 前端多选功能
  - 后端批量操作接口

- ⏳ **文档搜索增强** - 全文搜索、高级筛选
  - 按文件名搜索
  - 按内容搜索（需要全文索引）
  - 多条件组合筛选

- ⏳ **回收站功能完善** - 回收站UI和批量操作
  - 回收站页面
  - 批量恢复/永久删除

#### 低优先级
- ⏳ **文档分享功能** - 文档链接分享（预留接口已实现）
- ⏳ **文档评论/标注** - 文档协作功能
- ⏳ **文档版本回滚** - 回滚到指定版本
- ⏳ **文档差异查看** - 版本间差异对比

### 问答模块（未开始）

#### 核心功能
- ⏳ 会话管理（创建、列表、删除）
- ⏳ 消息管理（发送、接收、删除）
- ⏳ 知识库选择（文件夹/文档选择）
- ⏳ 向量检索（相似度搜索）
- ⏳ LLM对话（流式输出）
- ⏳ 引用片段展示

#### 高级功能
- ⏳ 重排序模型集成
- ⏳ 上下文管理（Token限制、摘要）
- ⏳ 多轮对话上下文保持
- ⏳ 会话级检索参数配置

### 系统管理模块待完善

#### 功能增强
- ⏳ **审计日志查看** - 审计日志查询和管理界面
- ⏳ **操作日志** - AOP切面记录操作日志
- ⏳ **速率限制** - API速率限制中间件
- ⏳ **配额管理** - 租户/用户配额管理

#### 认证功能
- ⏳ **注册功能** - 用户注册接口（预留）
- ⏳ **密码重置** - 密码重置功能（预留）
- ⏳ **MFA多因素认证** - OTP/短信/邮箱验证（预留）
- ⏳ **SSO/OIDC** - 单点登录集成（预留）

### 技术优化

#### 性能优化
- ⏳ **大文件分片上传** - 支持大文件分片上传和断点续传
- ⏳ **并发控制** - 上传/解析并发限制
- ⏳ **缓存机制** - 热门查询缓存
- ⏳ **数据库索引优化** - 根据查询模式优化索引

#### 可靠性增强
- ⏳ **重试机制完善** - 解析/向量化失败自动重试
- ⏳ **幂等性保证** - 上传/操作幂等性
- ⏳ **健康检查** - 服务健康检查接口
- ⏳ **监控告警** - 系统监控和告警

#### 安全增强
- ⏳ **病毒扫描** - 文件上传病毒扫描（预留接口）
- ⏳ **敏感词检测** - 内容敏感词检测（预留接口）
- ⏳ **访问控制** - 更细粒度的权限控制
- ⏳ **数据加密** - 敏感数据加密存储

### 文档完善

- ⏳ **API文档更新** - 更新接口文档，包含新增接口
- ⏳ **功能文档更新** - 更新功能文档，包含新功能说明
- ⏳ **用户手册更新** - 更新用户手册，包含新功能使用说明
- ⏳ **开发文档** - 技术架构文档、部署文档

---

## 已知问题

### 已修复
- ✅ 文档上传卡死问题（已修复：异步文件I/O）
- ✅ 向量化失败问题（已修复：split_method映射、批量大小限制）
- ✅ 标签创建问题（已修复：支持通过tag_name创建）
- ✅ 权限问题（已修复：菜单权限和API权限分离）

### 待解决
- ⚠️ 前端控制台编码问题（Windows GBK编码导致Unicode字符显示异常）
- ⚠️ 文档状态流转需要完善（某些状态转换逻辑）
- ⚠️ 向量化失败后的重试机制（目前只记录，未自动重试）

---

## 技术债务

1. **代码重构**
   - 部分服务类方法过长，需要拆分
   - 错误处理可以更统一
   - 日志记录可以更规范

2. **测试覆盖**
   - 单元测试缺失
   - 集成测试缺失
   - E2E测试缺失

3. **文档完善**
   - API文档需要更详细
   - 代码注释需要补充
   - 架构设计文档缺失

4. **性能优化**
   - 数据库查询优化
   - 缓存机制引入
   - 异步处理优化

---

## 下一步计划

### 短期（1-2周）
1. 完善文档管理模块的待办表功能
2. 实现版本覆盖逻辑（删除旧版本向量数据）
3. 前端文件夹重命名功能
4. 文档预览功能

### 中期（1个月）
1. 开始问答模块开发
2. 实现会话管理和消息管理
3. 实现向量检索和LLM对话
4. 实现引用片段展示

### 长期（2-3个月）
1. 完善问答模块高级功能
2. 系统性能优化
3. 安全功能增强
4. 测试覆盖和文档完善

---

## 更新日志

### 2024-12-14
- ✅ 完成文档删除接口（包含向量库和chunk删除）
- ✅ 完成文档恢复接口
- ✅ 完成回收站列表接口
- ✅ 完成版本管理接口（查询、删除）
- ✅ 完成按标签搜索文档功能
- ✅ 完成文档下载接口
- ✅ 完成最近使用的配置接口
- ✅ 完善文档状态管理（vectorizing、vectorize_failed）
- ✅ 前端添加下载功能
- ✅ 前端更新状态显示

### 2024-12-13
- ✅ 完成文档向量化功能
- ✅ 集成阿里云Embedding服务
- ✅ 实现ChromaDB本地存储
- ✅ 修复文档上传卡死问题
- ✅ 修复向量化批量大小限制问题

### 2024-12-12
- ✅ 完成文档管理模块基础功能
- ✅ 完成文件夹管理功能
- ✅ 完成标签管理功能
- ✅ 完成文档上传和解析功能

---

## 备注

- 本文档会持续更新，记录项目开发进度
- 已完成功能标记为 ✅
- 待办事项标记为 ⏳
- 已知问题标记为 ⚠️
- 技术债务标记为 📝

